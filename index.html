<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script>
// For√ßa o layout desktop em mobile e trava o zoom para caber sem sobras
(function(){
  const meta = document.querySelector('meta[name=\"viewport\"]');
  if (!meta) return;
  const ua = navigator.userAgent || '';
  const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(ua);

  const applyViewport = () => {
    const deviceWidthRaw = Math.min(window.innerWidth || 0, window.screen.width || 0) || 1280;
    // Pequena folga para evitar corte na lateral direita em algumas combina√ß√µes de navegador/zoom
    const deviceWidth = Math.max(320, deviceWidthRaw - 8);
    if (isMobile || deviceWidth < 1200){
      const targetWidth = 1280;
      const scale = Math.max(0.3, Math.min(1, (deviceWidth / targetWidth) * 0.98));
      // Ajusta para caber no eixo X com folga e libera pinch-zoom (inclusive depois de voltar do rodap√©)
      meta.setAttribute('content', `width=${targetWidth}, initial-scale=${scale}, minimum-scale=${Math.max(0.2, scale * 0.8)}, maximum-scale=5, user-scalable=yes`);
      document.documentElement.style.overflowX = 'hidden';
      document.body.style.overflowX = 'hidden';
      document.documentElement.style.width = '100%';
      document.body.style.width = '100%';
    }else{
      meta.setAttribute('content', 'width=device-width, initial-scale=1, user-scalable=yes, maximum-scale=5');
    }
  };

  applyViewport();
  window.addEventListener('pageshow', applyViewport);
})();
</script>
<title>Pre√ßoVs</title>

<style>
:root {
  --bg-main: #050505;
  --bg-header: #0a0a0a;
  --bg-section: #0f0f10;
  --bg-card: #151518;
  --bg-card-soft: #111115;
  --border-soft: #27272a;
  --text-main: #e5e5e5;
  --text-muted: #9ca3af;
  --accent-green: #22c55e;
  --accent-strong: #ffffff;
}

/* GLOBAL */
* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  background: radial-gradient(circle at top, #111827 0, #020617 45%, #000 100%);
  color: var(--text-main);
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  font-size: clamp(14px, 1.6vw, 16px);
}

.page-main{ flex:1; display:flex; flex-direction:column; }

/* Containers */
.page-section { max-width: 1400px; margin: 0 auto; padding: clamp(20px, 4vw, 32px) clamp(12px, 3vw, 16px); }
.section-title { font-size: 1.7rem; margin-bottom: 10px; font-weight: 600; }
.section-subtitle { color: var(--text-muted); font-size: 0.95rem; margin-bottom: 24px; }

/* ===========================
      HEADER
=========================== */
.top-header {
  background: var(--bg-header);
  padding: 12px 16px;
  color: white;
  border-bottom: 1px solid var(--border-soft);
  box-shadow: 0 6px 20px rgba(0,0,0,0.35);
}

.header-container {
  max-width: 1400px;
  margin: auto;
  display: flex;
  align-items: center;
  gap: 20px;
}

.logo {
  font-size: 1.8rem;
  font-weight: bold;
  color: white;
  letter-spacing: 0.03em;
}
.logo span { color: var(--accent-green); }

/* SEARCH */
.search-box { flex: 1; display: flex; }
.search-box input {
  flex: 1;
  padding: 10px;
  border: 1px solid #2e2e2e;
  background: #1a1a1a;
  color: white;
  border-radius: 6px 0 0 6px;
}
.search-box input::placeholder { color: #6b7280; }
.search-box button {
  padding: 10px 16px;
  border: none;
  background: #2e2e2e;
  color: white;
  border-radius: 0 6px 6px 0;
  cursor: pointer;
  font-weight: 500;
}
.search-box button:hover { background: #3b3b3b; }

/* ENDERE√áO */
.endereco {
  text-align: left;
  font-size: 0.85rem;
  line-height: 1.1rem;
  color: #e5e5e5;
  min-width: 140px;
}
.end-label { opacity: 0.6; }

/* ICONS AREA */
.account, .cart {
  display: flex;
  align-items: center;
  gap: 6px;
  cursor: pointer;
  color: #e5e5e5;
  font-size: 0.9rem;
}
.account span, .cart span { white-space: nowrap; }
.icon { width: 22px; height: 22px; filter: invert(100%); }

.cart { position: relative; }
.cart-count {
  position: absolute;
  top: -5px;
  right: -6px;
  background: #ef4444;
  padding: 2px 6px;
  font-size: 0.75rem;
  border-radius: 999px;
  font-weight: bold;
}

/* BARRA AVISO INTERMEDIADOR */
.info-bar { background: #020617; border-bottom: 1px solid var(--border-soft); }
.info-bar-inner {
  max-width: 1400px;
  margin: 0 auto;
  padding: 10px 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 0.85rem;
  color: var(--text-muted);
}
.info-pill {
  padding: 4px 10px;
  border-radius: 999px;
  border: 1px solid #1f2933;
  background: #020617;
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.06em;
}
.info-highlight { color: var(--accent-green); font-weight: 500; }

/* ===========================
      CARROSSEL
=========================== */
.carousel {
  position: relative;
  width: 100%;
  overflow: hidden;
  background: #000;
  border-bottom: 1px solid #111827;
}
.carousel-track { display: flex; transition: transform 0.5s ease; }
.carousel img { width: 100%; height: auto; object-fit: contain; display: block; }
.carousel-btn {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(15,23,42,0.6);
  border: 1px solid rgba(148,163,184,0.6);
  color: white;
  font-size: 2rem;
  padding: 8px 14px;
  cursor: pointer;
  border-radius: 999px;
  backdrop-filter: blur(6px);
}
.carousel-btn.prev { left: 18px; }
.carousel-btn.next { right: 18px; }
.carousel-btn:hover { background: rgba(15,23,42,0.9); }

/* ===========================
      HERO / CONCEITO
=========================== */
.hero {
  display: grid;
  grid-template-columns: minmax(0, 1.5fr) minmax(0, 1fr);
  gap: 28px;
  align-items: center;
}
.hero-left h1 { font-size: 2.2rem; margin-bottom: 12px; }
.hero-left h1 span { color: var(--accent-green); }
.hero-left p { color: var(--text-muted); font-size: 0.95rem; margin-bottom: 18px; }

.hero-badges { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 22px; }
.hero-badge {
  font-size: 0.75rem;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid var(--border-soft);
  background: var(--bg-card-soft);
  color: var(--text-muted);
}
.hero-actions { display: flex; flex-wrap: wrap; gap: 10px; }

.btn-primary {
  background: var(--accent-green);
  color: #020617;
  border: none;
  padding: 10px 18px;
  border-radius: 999px;
  font-weight: 600;
  font-size: 0.9rem;
  cursor: pointer;
}
.btn-outline {
  background: transparent;
  color: var(--accent-strong);
  border-radius: 999px;
  border: 1px solid var(--border-soft);
  padding: 9px 16px;
  font-size: 0.88rem;
  cursor: pointer;
}
.btn-outline:hover { background: #111827; }

.hero-right {
  background: radial-gradient(circle at top, #1f2937 0, #020617 65%);
  border-radius: 18px;
  padding: 16px 18px;
  border: 1px solid #1f2937;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.hero-right-title { font-size: 0.95rem; margin-bottom: 4px; }
.hero-compare-row {
  display: flex;
  justify-content: space-between;
  font-size: 0.85rem;
  padding: 8px 10px;
  border-radius: 10px;
  background: rgba(15,23,42,0.8);
  border: 1px solid #111827;
}
.hero-compare-row.best { border-color: var(--accent-green); background: rgba(22,163,74,0.08); }
.hero-legend { font-size: 0.75rem; color: var(--text-muted); margin-top: 6px; }

/* ===========================
      SETORES ‚Äî SEM SCROLL
=========================== */
.sectors-box {
  margin-top: 18px;
  background: rgba(15,23,42,0.55);
  border: 1px solid #1f2937;
  border-radius: 18px;
  padding: 16px;
}
.sectors-grid {
  display: grid;
  grid-template-columns: repeat(12, minmax(0, 1fr));
  gap: 10px;
  overflow: hidden;
  grid-auto-rows: 1fr;
}
.sector-card {
  position: relative;
  overflow: hidden;
  border-radius: 14px;
  border: 1px solid #1f2937;
  background-color: #000;
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  aspect-ratio: 1 / 1;
  display: flex;
  align-items: flex-end;
  justify-content: center;
  padding: clamp(8px, 1vw, 14px) clamp(6px, 0.9vw, 10px);
  user-select: none;
  transition: transform 0.15s ease, border-color 0.15s ease;
}
.sector-card::before {
  content: "";
  position: absolute;
  inset: 0;
  background: linear-gradient(to top, rgba(0,0,0,0.78), rgba(0,0,0,0.18));
}
.sector-card span {
  position: relative;
  z-index: 1;
  font-size: clamp(0.55rem, 0.85vw, 0.88rem);
  font-weight: 650;
  color: var(--text-main);
  text-align: center;
  line-height: 1.1;
  padding: 0 4px;
}
.sector-card:hover { border-color: rgba(34,197,94,0.45); transform: translateY(-1px); }

.sectors-grid .sector-card:nth-child(1)  { background-image: url("setor1.png"); }
.sectors-grid .sector-card:nth-child(2)  { background-image: url("setor2.png"); }
.sectors-grid .sector-card:nth-child(3)  { background-image: url("setor3.png"); }
.sectors-grid .sector-card:nth-child(4)  { background-image: url("setor4.png"); }
.sectors-grid .sector-card:nth-child(5)  { background-image: url("setor5.png"); }
.sectors-grid .sector-card:nth-child(6)  { background-image: url("setor6.png"); }
.sectors-grid .sector-card:nth-child(7)  { background-image: url("setor7.png"); }
.sectors-grid .sector-card:nth-child(8)  { background-image: url("setor8.png"); }
.sectors-grid .sector-card:nth-child(9)  { background-image: url("setor9.png"); }
.sectors-grid .sector-card:nth-child(10) { background-image: url("setor10.png"); }
.sectors-grid .sector-card:nth-child(11) { background-image: url("setor11.png"); }
.sectors-grid .sector-card:nth-child(12) { background-image: url("setor12.png"); }

@media (max-width: 1200px) { .sectors-grid { grid-template-columns: repeat(6, minmax(0, 1fr)); grid-auto-rows: 1fr; } }
@media (max-width: 820px)  { .sectors-grid { grid-template-columns: repeat(6, minmax(0, 1fr)); grid-auto-rows: 1fr; } }
@media (max-width: 520px)  { .sectors-grid { grid-template-columns: repeat(6, minmax(0, 1fr)); grid-auto-rows: 1fr; } }

/* ===========================
      CAT√ÅLOGO ‚Äî S√ì PRODUTOS VIS√çVEL
=========================== */
.catalog-shell{
  margin-top: 16px;
  background: rgba(15,23,42,0.55);
  border: 1px solid #1f2937;
  border-radius: 18px;
  padding: 14px;
  overflow-x: auto;
}

.catalog-toolbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  padding:12px;
  margin-bottom:12px;
  background: linear-gradient(120deg, rgba(34,197,94,0.08), rgba(2,6,23,0.85));
  border:1px solid #16302a;
  border-radius:14px;
  box-shadow:0 10px 30px rgba(0,0,0,0.25);
  flex-wrap:wrap;
}
.catalog-filter, .catalog-search{
  display:flex;
  flex-direction:column;
  gap:6px;
  min-width:240px;
  flex:1;
}
.catalog-filter label, .catalog-search label{
  font-size:0.82rem;
  color: var(--text-muted);
  letter-spacing:0.02em;
}
.catalog-filter select{
  padding:10px 12px;
  background:#0a0f14;
  color:var(--text-main);
  border:1px solid #1f2937;
  border-radius:12px;
  font-weight:650;
  outline:none;
  box-shadow: inset 0 0 0 1px rgba(34,197,94,0.12);
}
.catalog-filter select:focus{ border-color: rgba(34,197,94,0.6); box-shadow:0 0 0 1px rgba(34,197,94,0.35); }
.catalog-section-filter.disabled{ opacity:0.6; }
.catalog-section-filter.disabled select{ cursor:not-allowed; }
.catalog-tags{ display:flex; gap:6px; flex-wrap:wrap; align-items:center; }
.catalog-pill-alt{ background: rgba(34,197,94,0.16); }
.catalog-search-box{
  display:flex;
  align-items:center;
  gap:8px;
  padding:10px 12px;
  border-radius:12px;
  background:#0a0f14;
  border:1px solid #1f2937;
  box-shadow: inset 0 0 0 1px rgba(34,197,94,0.12);
}
.catalog-search-box input{
  flex:1;
  background:transparent;
  border:none;
  outline:none;
  color:var(--text-main);
  font-size:0.95rem;
}
.catalog-search-box input::placeholder{ color: var(--text-muted); }
.catalog-search-clear{
  padding:8px 12px;
  border-radius:10px;
  border:1px solid #1f2937;
  background:rgba(34,197,94,0.12);
  color:var(--accent-green);
  cursor:pointer;
  font-weight:700;
}
.catalog-search-clear:hover{ background:rgba(34,197,94,0.2); }

/* CONTROLES OCULTOS (CTRL+SHIFT+L ou #admin) */
.catalog-controls{
  display:none;
  margin-bottom: 12px;
  background: rgba(2,6,23,0.85);
  border: 1px solid #111827;
  border-radius: 14px;
  padding: 12px;
}
.catalog-controls.show{ display:block; }

.catalog-controls label{ font-size:12px; color: var(--text-muted); }
.catalog-controls input[type="file"]{ color: var(--text-muted); max-width: 520px; }
.catalog-controls .row{
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  align-items:flex-end;
}

.catalog-btn{
  background:#0f0f11;
  border:1px solid #1f2937;
  color:var(--text-main);
  padding:10px 14px;
  border-radius:10px;
  cursor:pointer;
  font-weight: 650;
}
.catalog-btn:disabled{ opacity:.5; cursor:not-allowed; }

.catalog-status, .catalog-debug{ display:none; }

.catalog-grid{
  display:grid;
  grid-template-columns: repeat(5, minmax(150px, 1fr));
  gap: 12px;
  min-width: 750px;
}
.catalog-grid.catalog-grid-mobile{
  grid-template-columns: repeat(2, minmax(0, 1fr));
  min-width: 0;
}
.catalog-empty{
  grid-column: 1 / -1;
  text-align:center;
  padding:30px 16px;
  border:1px dashed #1f2937;
  border-radius:14px;
  color: var(--text-muted);
  background: rgba(2,6,23,0.6);
}
.catalog-card{
  background: rgba(3,7,18,0.65);
  border: 1px solid #111827;
  border-radius: 14px;
  padding: 12px;
  min-height: 160px;
  display:flex;
  flex-direction:column;
  gap: 10px;
}
.catalog-meta{
  display:flex;
  justify-content:space-between;
  align-items:center;
  color: var(--text-muted);
  font-size:12px;
}
.catalog-pill{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid #1f2937;
  background: rgba(34,197,94,0.08);
  color: var(--accent-green);
  font-weight:700;
  font-size:11px;
  letter-spacing:0.02em;
}
.catalog-actions{
  display:flex;
  align-items:center;
  gap:10px;
  margin-top:auto;
}
.qty-control{
  display:inline-flex;
  align-items:center;
  border:1px solid rgba(255,255,255,0.08);
  background:#0c1220;
  border-radius:10px;
  overflow:hidden;
  box-shadow: inset 0 0 0 1px rgba(34,197,94,0.12);
}
.qty-btn{
  width:36px;
  height:36px;
  background:#0f172a;
  color:var(--accent-green);
  border:none;
  cursor:pointer;
  font-weight:900;
  font-size:20px;
  display:flex;
  align-items:center;
  justify-content:center;
}
.qty-btn + .qty-btn{ border-left:1px solid rgba(255,255,255,0.06); }
.qty-btn:hover{ background:rgba(34,197,94,0.15); }
.qty-input{
  width:50px;
  background:#0f172a;
  border:none;
  text-align:center;
  color:var(--text-main);
  font-weight:700;
  outline:none;
  height:36px;
}
.catalog-add{
  flex:1;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid rgba(34,197,94,0.4);
  background: linear-gradient(120deg, rgba(34,197,94,0.15), rgba(34,197,94,0.32));
  color:var(--accent-strong);
  font-weight:800;
  cursor:pointer;
  transition: transform 0.1s ease, box-shadow 0.2s ease, filter 0.2s ease;
  box-shadow:0 10px 25px rgba(34,197,94,0.15);
}
.catalog-add:hover{ transform: translateY(-1px); box-shadow:0 14px 30px rgba(34,197,94,0.25); }
.catalog-add.added{
  background: linear-gradient(120deg, rgba(34,197,94,0.35), rgba(34,197,94,0.55));
  border-color: rgba(34,197,94,0.7);
  animation: add-pop 0.5s ease;
  filter: drop-shadow(0 0 12px rgba(34,197,94,0.35));
}
.catalog-grid.catalog-grid-mobile .catalog-card{ gap:12px; }
.catalog-grid.catalog-grid-mobile .catalog-name{ font-size:1.05rem; line-height:1.4; }
.catalog-grid.catalog-grid-mobile .catalog-meta{ font-size:13px; }
.catalog-grid.catalog-grid-mobile .qty-btn{ width:44px; height:44px; font-size:22px; }
.catalog-grid.catalog-grid-mobile .qty-input{ width:64px; height:44px; font-size:1.05rem; }
.catalog-grid.catalog-grid-mobile .catalog-add{ padding:12px 14px; font-size:1rem; }
.catalog-grid.catalog-grid-mobile .catalog-price{ font-size:1.02rem; }

@media (max-width: 720px){
  .catalog-toolbar{
    flex-direction:column;
    align-items:stretch;
    gap:14px;
  }
  .catalog-filter, .catalog-search, .catalog-section-filter{
    width:100%;
    min-width:0;
  }
  .catalog-filter label, .catalog-search label{
    font-size:0.95rem;
  }
  .catalog-filter select,
  .catalog-search-box input{
    font-size:1rem;
    padding:12px;
  }
  .catalog-search-clear{
    font-size:1rem;
    padding:10px 14px;
  }
  .catalog-randomize-top button{
    width:100%;
    font-size:1rem;
    padding:12px 16px;
  }
  .catalog-pill, .catalog-pill-alt{
    font-size:12px;
  }
}
.catalog-grid.catalog-grid-mobile .catalog-card{ gap:12px; }
.catalog-grid.catalog-grid-mobile .catalog-name{ font-size:1rem; line-height:1.35; }
.catalog-grid.catalog-grid-mobile .catalog-meta{ font-size:13px; }
.catalog-grid.catalog-grid-mobile .qty-btn{ width:42px; height:42px; font-size:22px; }
.catalog-grid.catalog-grid-mobile .qty-input{ width:60px; height:42px; font-size:1rem; }
.catalog-grid.catalog-grid-mobile .catalog-add{ padding:12px 14px; font-size:0.95rem; }
.catalog-grid.catalog-grid-mobile .catalog-price{ font-size:1rem; }
.cart-count.bump{ animation: cart-bounce 0.6s ease; }

@keyframes add-pop{
  0%{ transform: scale(1); }
  40%{ transform: scale(1.08) translateY(-2px); }
  70%{ transform: scale(0.98); }
  100%{ transform: scale(1); }
}
@keyframes cart-bounce{
  0%{ transform: scale(1); }
  30%{ transform: scale(1.15) translateY(-2px); }
  60%{ transform: scale(0.9); }
  100%{ transform: scale(1); }
}

/* FOOTER */
.site-footer{
  margin-top:50px;
  background: radial-gradient(circle at 20% 20%, rgba(34,197,94,0.1), transparent 25%), #050608;
  border-top:1px solid #111827;
  padding:36px 16px 28px;
  color:var(--text-main);
}
.footer-inner{
  max-width:1400px;
  margin:0 auto;
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap:20px;
}
.footer-col h4{
  font-size:1.05rem;
  margin-bottom:10px;
  font-weight:800;
}
.footer-col ul{ list-style:none; display:flex; flex-direction:column; gap:6px; }
.footer-col a{
  color:var(--text-muted);
  text-decoration:none;
  font-size:0.95rem;
}
.footer-col a:hover{ color:var(--accent-green); }
.footer-trust-list{
  list-style:none;
  display:flex;
  flex-direction:column;
  gap:6px;
  color:var(--text-muted);
  font-size:0.94rem;
}
.footer-trust-list li::before{
  content:"‚úì";
  color:var(--accent-green);
  margin-right:6px;
  font-weight:800;
}
.footer-pill{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:10px 12px;
  background: rgba(34,197,94,0.12);
  border:1px solid rgba(34,197,94,0.3);
  border-radius:12px;
  font-weight:750;
  color:var(--accent-green);
  margin-top:8px;
  box-shadow:0 10px 24px rgba(34,197,94,0.12);
}
.footer-bottom{
  margin-top:20px;
  padding-top:16px;
  border-top:1px solid #111827;
  display:flex;
  flex-wrap:wrap;
  align-items:center;
  justify-content:space-between;
  gap:12px;
}
.footer-back-btn{
  background:linear-gradient(120deg, rgba(34,197,94,0.3), rgba(34,197,94,0.6));
  color:#020617;
  border:none;
  padding:12px 16px;
  border-radius:12px;
  font-weight:850;
  cursor:pointer;
  box-shadow:0 10px 25px rgba(34,197,94,0.2);
}
.footer-back-btn:hover{ box-shadow:0 14px 30px rgba(34,197,94,0.3); transform:translateY(-1px); }

/* CART PANEL */
.cart-panel{
  position: fixed;
  top: 70px;
  right: 16px;
  width: min(360px, 90vw);
  max-height: 70vh;
  background: rgba(9,12,20,0.96);
  border:1px solid #1f2937;
  border-radius:14px;
  box-shadow:0 24px 70px rgba(0,0,0,0.45);
  backdrop-filter: blur(8px);
  display:none;
  flex-direction:column;
  z-index: 999;
}
.cart-panel.show{ display:flex; }
.cart-panel-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px 14px;
  border-bottom:1px solid #111827;
  font-weight:800;
}
.cart-panel-close{
  background:#0b0f17;
  color:var(--text-main);
  border:1px solid #1f2937;
  border-radius:10px;
  padding:8px 12px;
  cursor:pointer;
}
.cart-items{
  padding:12px;
  overflow:auto;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.cart-empty{
  color:var(--text-muted);
  text-align:center;
  padding:20px;
  border:1px dashed #1f2937;
  border-radius:10px;
}
.cart-item{
  display:flex;
  gap:10px;
  border:1px solid #1f2937;
  border-radius:12px;
  padding:10px;
  background: #0b0f17;
}
.cart-thumb{
  width:64px;
  height:64px;
  border-radius:10px;
  overflow:hidden;
  background:#0f172a;
  border:1px solid #111827;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:11px;
  color:var(--text-muted);
}
.cart-thumb img{
  width:100%;
  height:100%;
  object-fit:contain;
}
.cart-info{
  flex:1;
  display:flex;
  flex-direction:column;
  gap:4px;
}
.cart-title{ font-weight:800; font-size:14px; }
.cart-meta{
  display:flex;
  gap:8px;
  font-size:12px;
  color:var(--text-muted);
}
.cart-remove{
  align-self:flex-start;
  background:rgba(239,68,68,0.12);
  color:#f87171;
  border:1px solid rgba(239,68,68,0.35);
  border-radius:10px;
  padding:6px 10px;
  cursor:pointer;
  font-weight:700;
  font-size:12px;
}

/* CART FLOATER */
.cart-floater{
  position:fixed;
  bottom:16px;
  left:50%;
  transform:translateX(-50%) translateY(120%);
  width:min(520px, 90vw);
  background: linear-gradient(160deg, rgba(18,24,40,0.92), rgba(15,23,42,0.9));
  border:1px solid rgba(255,255,255,0.06);
  border-radius:16px;
  box-shadow:0 16px 60px rgba(0,0,0,0.45), 0 0 0 1px rgba(34,197,94,0.15);
  backdrop-filter: blur(12px);
  padding:14px;
  transition: transform 0.25s ease, opacity 0.25s ease;
  opacity:0;
  z-index:998;
}
.cart-floater.show{
  transform:translateX(-50%) translateY(0);
  opacity:1;
}
.cart-floater-main{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
}
.cart-floater-meta{
  display:flex;
  flex-direction:column;
  gap:6px;
}
.cart-floater-label{ font-weight:850; font-size:1rem; letter-spacing:0.01em; }
.cart-floater-values{ color:var(--text-muted); font-size:0.92rem; }
.cart-floater-market{ color:var(--accent-green); font-weight:700; font-size:0.92rem; }
.cart-floater-btn{
  background:var(--accent-green);
  color:#020617;
  border:none;
  padding:10px 14px;
  border-radius:12px;
  font-weight:800;
  cursor:pointer;
  min-width:120px;
}
.cart-floater-actions{
  display:flex;
  flex-direction:column;
  gap:8px;
  align-items:flex-end;
}
.cart-floater-visit{
  background:linear-gradient(120deg, rgba(34,197,94,0.25), rgba(34,197,94,0.5));
  color:#020617;
  border:none;
  padding:10px 14px;
  border-radius:12px;
  font-weight:800;
  cursor:pointer;
  min-width:140px;
  box-shadow:0 10px 30px rgba(34,197,94,0.18);
}
.catalog-thumb{
  width:100%;
  aspect-ratio: 1/1;
  border:1px solid #111827;
  border-radius: 12px;
  background: rgba(2,6,23,0.7);
  overflow:hidden;
  display:flex;
  align-items:center;
  justify-content:center;
}
.catalog-thumb img{
  width:100%;
  height:100%;
  object-fit:contain;
  display:block;
}
.catalog-noimg{
  font-size:12px;
  color: var(--text-muted);
  padding:8px;
  text-align:center;
}
.catalog-name{ font-weight:800; font-size:14px; line-height:1.2; margin:0; word-break:break-word; }
.catalog-price{ font-weight:950; color: var(--accent-green); white-space:nowrap; margin-left:auto; }

.catalog-pager{
  margin-top: 12px;
  display:flex;
  justify-content:center;
  align-items:center;
  gap: 10px;
  padding: 10px;
  border:1px solid #111827;
  background: rgba(2,6,23,0.85);
  border-radius: 14px;
}
.catalog-pager .info{ display:none; }
.catalog-randomize{
  text-align:center;
  margin-top:10px;
}
.catalog-randomize button{
  background:linear-gradient(120deg, rgba(34,197,94,0.25), rgba(34,197,94,0.45));
  border:1px solid rgba(34,197,94,0.4);
  color:var(--accent-strong);
  padding:10px 14px;
  border-radius:12px;
  font-weight:800;
  cursor:pointer;
  box-shadow:0 10px 25px rgba(34,197,94,0.15);
}
.catalog-randomize-top{
  margin-top:0;
  text-align:right;
}

@media (max-width: 720px){
  .catalog-toolbar{ flex-direction:column; align-items:stretch; }
  .catalog-filter, .catalog-search{ min-width: auto; }
  .catalog-toolbar{ padding:10px; }
  .catalog-search-box{ padding:8px 10px; }
  .catalog-randomize button{ width:100%; }
}

/* RESPONSIVO GERAL */
@media (max-width: 820px) {
  .hero { grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr); }
}
@media (max-width: 640px) {
  .header-container { flex-wrap: wrap; }
  .hero { grid-template-columns: minmax(0,1fr); }
  .info-bar-inner { flex-direction: column; align-items: flex-start; }
  .hero { gap:18px; }
  .page-section{ padding:18px 12px; }
  .catalog-shell{ padding:12px; }
  .cart-panel{ width:90vw; right:5vw; }
  .cart-floater{ width:92vw; left:4vw; transform:translateY(120%); }
  .footer-inner{ grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); }
}

@media (max-width: 640px){
  .top-header{ padding:10px; }
  .header-container{
    flex-direction:column;
    align-items:flex-start;
    gap:12px;
  }
  .search-box{ width:100%; order:2; }
  .logo{ order:1; }
  .endereco, .account, .cart{ order:3; width:100%; justify-content:space-between; }
  .endereco, .account, .cart{ width:100%; justify-content:space-between; }
  .hero{ gap:18px; }
  .page-section{ padding:24px 14px; }
  .catalog-shell{ padding:12px; }
  .cart-panel{ width:90vw; right:5vw; }
  .cart-floater{ width:92vw; left:4vw; transform:translateY(120%); }
  .footer-inner{ grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); }
}
</style>
</head>

<body>

<div class="page-main">

<div class="top-wrap">
  <header class="top-header">
    <div class="header-container">
      <div class="logo">Pre√ßo<span>Vs</span></div>

      <div class="search-box">
        <input id="globalSearch" type="text" placeholder="Pesquisar produtos...">
        <button id="globalSearchBtn" type="button">Buscar</button>
      </div>

      <div class="endereco">
        <span class="end-label">Entrega em:</span>
        <span id="enderecoCliente">Selecionar endere√ßo</span>
      </div>

      <div class="account">
        <img src="https://cdn-icons-png.flaticon.com/512/1144/1144760.png" class="icon" alt="Conta">
        <span>Minha Conta</span>
      </div>

      <div class="cart">
        <img src="https://cdn-icons-png.flaticon.com/512/3144/3144456.png" class="icon" alt="Carrinho">
        <span>Carrinho</span>
        <div class="cart-count" id="cartCount">0</div>
      </div>
    </div>
  </header>

  <div class="info-bar">
    <div class="info-bar-inner">
      <div class="info-pill">Intermediador</div>
      <div>
        N√≥s n√£o vendemos produtos. <span class="info-highlight">Voc√™ escolhe o carrinho ideal</span> e finaliza a compra direto no site do supermercado escolhido.
      </div>
    </div>
  </div>
</div>

<div class="cart-panel" id="cartPanel">
  <div class="cart-panel-header">
    <span>Seu carrinho (<span id="cartCountLabel">0</span>)</span>
    <button class="cart-panel-close" id="cartCloseBtn" type="button">Fechar</button>
  </div>
  <div class="cart-items" id="cartItems"></div>
</div>

<div class="cart-floater" id="cartFloater">
  <div class="cart-floater-main">
    <div class="cart-floater-meta">
      <div class="cart-floater-label">Resumo r√°pido do carrinho</div>
      <div class="cart-floater-values"><span id="floaterCount">0 itens</span> ¬∑ <span id="floaterTotal">R$ 0,00</span></div>
      <div class="cart-floater-market">Mercado mais barato (estimativa): <span id="floaterBest">-</span></div>
    </div>
    <div class="cart-floater-actions">
      <button class="cart-floater-btn" id="floaterOpenCart" type="button">Ver carrinho</button>
      <button class="cart-floater-visit" id="floaterVisitSite" type="button">Visitar o Site</button>
    </div>
  </div>
</div>

<!-- CARROSSEL (7 BANNERS) -->
<section class="carousel">
  <div class="carousel-track">
    <img src="banner1.png" alt="Banner 1">
    <img src="banner2.png" alt="Banner 2">
    <img src="banner3.png" alt="Banner 3">
    <img src="banner4.png" alt="Banner 4">
    <img src="banner5.png" alt="Banner 5">
    <img src="banner6.png" alt="Banner 6">
    <img src="banner7.png" alt="Banner 7">
  </div>
  <button class="carousel-btn prev" type="button">‚Äπ</button>
  <button class="carousel-btn next" type="button">‚Ä∫</button>
</section>

<section class="page-section">
  <div class="hero">
    <div class="hero-left">
      <h1>O jeito inteligente de montar seu carrinho <span>sem trocar de mercado toda hora</span>.</h1>
      <p>
        O Pre√ßoVs conecta voc√™ a v√°rios supermercados ao mesmo tempo.
        Voc√™ escolhe os produtos, n√≥s mostramos quem est√° ganhando em valor total e onde compensa fechar a compra.
      </p>

      <div class="hero-badges">
        <div class="hero-badge">N√£o somos supermercado</div>
        <div class="hero-badge">Compara√ß√£o em tempo quase real*</div>
        <div class="hero-badge">Foco em economia de tempo e dinheiro</div>
      </div>

      <div class="hero-actions">
        <button class="btn-primary" type="button" id="goCatalog">Come√ßar a comparar</button>
        <button class="btn-outline" type="button" id="goHow">Ver como funciona passo a passo</button>
      </div>
    </div>

    <div class="hero-right">
      <div class="hero-right-title">Exemplo de compara√ß√£o do seu carrinho:</div>

      <div class="hero-compare-row best">
        <span>Mercado A</span>
        <span>R$ 132,70</span>
        <span style="font-size:0.78rem;color:var(--accent-green);">Melhor op√ß√£o</span>
      </div>
      <div class="hero-compare-row">
        <span>Mercado B</span>
        <span>R$ 141,20</span>
        <span style="font-size:0.78rem;color:var(--text-muted);">Diferen√ßa: +R$ 8,50</span>
      </div>
      <div class="hero-compare-row">
        <span>Mercado C</span>
        <span>R$ 149,90</span>
        <span style="font-size:0.78rem;color:var(--text-muted);">Diferen√ßa: +R$ 17,20</span>
      </div>

      <div class="hero-legend">
        Voc√™ adiciona detergente, leite, arroz... n√≥s atualizamos qual mercado est√° na frente e quanto voc√™ est√° economizando.
      </div>
    </div>
  </div>

  <!-- SETORES -->
  <div class="sectors-box">
    <div class="sectors-grid">
      <div class="sector-card"><span>Mercearia Salgada</span></div>
      <div class="sector-card"><span>Mercearia Doce</span></div>
      <div class="sector-card"><span>Saud√°veis</span></div>
      <div class="sector-card"><span>Bebidas</span></div>
      <div class="sector-card"><span>Perfumaria</span></div>
      <div class="sector-card"><span>Bazar</span></div>
      <div class="sector-card"><span>Limpeza</span></div>
      <div class="sector-card"><span>Frios</span></div>
      <div class="sector-card"><span>A√ßougue</span></div>
      <div class="sector-card"><span>Padaria</span></div>
      <div class="sector-card"><span>Hortifruti</span></div>
      <div class="sector-card"><span>Congelados</span></div>
    </div>
  </div>

  <!-- CAT√ÅLOGO (S√ì PRODUTOS VIS√çVEL) -->
  <div class="catalog-shell" id="catalogoProdutos">

    <!-- CONTROLES OCULTOS (n√£o perde funcionalidade) -->
    <div class="catalog-controls" id="catalogControls">
      <div class="row">
        <div>
          <label>AUTO ‚Äî ./PRODUTOS/index.json</label><br>
          <button class="catalog-btn" id="btnAuto" type="button">AUTO carregar</button>
        </div>

        <div>
          <label>Op√ß√£o A: selecionar pasta PRODUTOS</label><br>
          <input id="dirPicker" type="file" webkitdirectory multiple accept=".xlsx,.xlsm">
        </div>

        <div>
          <label>Op√ß√£o B: selecionar arquivos</label><br>
          <input id="filePicker" type="file" multiple accept=".xlsx,.xlsm">
        </div>

        <button class="catalog-btn" id="btnLoad" type="button">Carregar</button>
      </div>
    </div>

    <div class="catalog-status" id="status"></div>
    <div class="catalog-debug" id="debug"></div>

    <div class="catalog-toolbar">
      <div class="catalog-filter">
        <label for="sectorFilter">Filtrar por setor</label>
        <select id="sectorFilter">
          <option value="__all">Todos os setores</option>
        </select>
      </div>
      <div class="catalog-filter catalog-section-filter" id="sectionFilterWrap">
        <label for="sectionFilter">Se√ß√£o (opcional)</label>
        <select id="sectionFilter" disabled>
          <option value="__all">Todas as se√ß√µes</option>
        </select>
      </div>
      <div class="catalog-search">
        <label for="catalogSearch">Buscar no cat√°logo (ao vivo)</label>
        <div class="catalog-search-box">
          <input id="catalogSearch" type="text" placeholder="Digite o nome do produto...">
          <button class="catalog-search-clear" id="catalogSearchClear" type="button">Limpar</button>
        </div>
      </div>
      <div class="catalog-randomize catalog-randomize-top">
        <button id="randomizeBtn" type="button">Aleatorizar produtos</button>
      </div>
    </div>

    <div class="catalog-grid" id="grid"></div>

    <div class="catalog-pager">
      <button class="catalog-btn" id="prevBtn" type="button">Voltar</button>
      <button class="catalog-btn" id="nextBtn" type="button">Pr√≥ximo</button>
      <div class="info" id="pageInfo">P√°gina</div>
    </div>
  </div>
</section>

</div>

<footer class="site-footer" id="rodape">
  <div class="footer-inner">
    <div class="footer-col">
      <h4>Sobre o Pre√ßoVs</h4>
      <p class="footer-pill">Intermediador ¬∑ Melhor pre√ßo total</p>
      <ul>
        <li><a href="como-funciona.html">Como funciona</a></li>
        <li><a href="catalogo.html">Cat√°logo</a></li>
        <li><a href="faq.html">Perguntas frequentes</a></li>
      </ul>
    </div>
    <div class="footer-col">
      <h4>Seguran√ßa</h4>
      <p class="footer-pill">üõ°Ô∏è 100% Seguro</p>
      <ul class="footer-trust-list">
        <li>Pagamento direto no site que voc√™ escolher</li>
        <li>Dados trafegam com prote√ß√£o SSL</li>
        <li>Sem v√≠nculo comercial com mercados</li>
      </ul>
    </div>
    <div class="footer-col">
      <h4>Ajuda</h4>
      <ul>
        <li><a href="suporte.html">Suporte</a></li>
        <li><a href="politica-entrega.html">Pol√≠tica de entrega</a></li>
        <li><a href="politica-devolucao.html">Pol√≠tica de devolu√ß√£o</a></li>
        <li><a href="privacidade.html">Privacidade</a></li>
      </ul>
    </div>
  </div>
  <div class="footer-bottom">
    <span>¬© 2025 Pre√ßoVs ¬∑ Economia e compara√ß√£o em um s√≥ lugar.</span>
    <button class="footer-back-btn" id="footerBackBtn" type="button">Ir para o topo</button>
  </div>
</footer>

<script>
/* ===========================
   CARROSSEL + SCROLL
=========================== */
let index = 0;
const track = document.querySelector('.carousel-track');
const slides = document.querySelectorAll('.carousel img');
const total = slides.length;

function updateCarousel(){ track.style.transform = `translateX(-${index * 100}%)`; }
document.querySelector('.next').onclick = () => { index = (index + 1) % total; updateCarousel(); };
document.querySelector('.prev').onclick = () => { index = (index - 1 + total) % total; updateCarousel(); };
setInterval(() => { index = (index + 1) % total; updateCarousel(); }, 5000);

document.getElementById('goCatalog').addEventListener('click', () => {
  document.getElementById('catalogoProdutos').scrollIntoView({ behavior: 'smooth', block: 'start' });
});
document.getElementById('goHow').addEventListener('click', () => {
  window.scrollTo({ top: document.body.scrollHeight * 0.4, behavior: 'smooth' });
});

/* ===========================
   CAT√ÅLOGO (XLSX + AUTO)
=========================== */
const IS_MOBILE = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent || '');
const PAGE_SIZE = IS_MOBILE ? 30 : 50;
let itemsBase = [];
let itemsAll = [];
let items = [];
let page = 1;
let pages = 1;

const dirPicker = document.getElementById('dirPicker');
const filePicker = document.getElementById('filePicker');
const btnLoad = document.getElementById('btnLoad');
const btnAuto = document.getElementById('btnAuto');

const statusEl = document.getElementById('status');
const debugEl = document.getElementById('debug');
const gridEl = document.getElementById('grid');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const pageInfo = document.getElementById('pageInfo');
if (IS_MOBILE && gridEl) gridEl.classList.add('catalog-grid-mobile');

const globalSearch = document.getElementById('globalSearch');
const globalSearchBtn = document.getElementById('globalSearchBtn');
const catalogSearch = document.getElementById('catalogSearch');
const catalogSearchClear = document.getElementById('catalogSearchClear');
const sectorFilter = document.getElementById('sectorFilter');
const sectionFilter = document.getElementById('sectionFilter');
const sectionFilterWrap = document.getElementById('sectionFilterWrap');
const cartCountEl = document.getElementById('cartCount');
const cartCountLabel = document.getElementById('cartCountLabel');
const cartPanel = document.getElementById('cartPanel');
const cartCloseBtn = document.getElementById('cartCloseBtn');
const cartItemsEl = document.getElementById('cartItems');
const cartFloater = document.getElementById('cartFloater');
const floaterCount = document.getElementById('floaterCount');
const floaterTotal = document.getElementById('floaterTotal');
const floaterBest = document.getElementById('floaterBest');
const floaterOpenCart = document.getElementById('floaterOpenCart');
const floaterVisitSite = document.getElementById('floaterVisitSite');
const SITE_URL = (location.origin && location.origin !== 'null') ? location.origin : 'https://';
const randomizeBtn = document.getElementById('randomizeBtn');
const footerBackBtn = document.getElementById('footerBackBtn');

const DEFAULT_SECTORS = [
  'Mercearia Salgada','Mercearia Doce','Saud√°veis','Bebidas','Perfumaria','Bazar',
  'Limpeza','Frios','A√ßougue','Padaria','Hortifruti','Congelados'
];

const cart = new Map();
let sectorOptionsSignature = '';
let sectionOptionsSignature = '';
const sectorHints = new Set();

function setStatus(msg){ statusEl.textContent = msg; }
function setDebug(html){ debugEl.innerHTML = html; }
function escapeHtml(s){
  return (s ?? '').toString()
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#039;");
}

function encodePath(p){
  return (p || '')
    .split('/')
    .filter(Boolean)
    .map(encodeURIComponent)
    .join('/');
}

function resolveImgPath(raw){
  const img = (raw || '').toString().trim();
  if (!img) return '';
  const low = img.toLowerCase();
  if (low.startsWith('http://') || low.startsWith('https://') || low.startsWith('data:') || low.startsWith('blob:')) return img;
  if (img.startsWith('/')) return img;
  if (img.startsWith('./') || img.startsWith('../')) return img;
  return './' + img.replace(/^\/+/,'');
}

function hasImage(p){
  return !!(p && (p.imagem || '').toString().trim());
}

function prioritizeImages(list){
  const withImg = [];
  const withoutImg = [];
  for (const item of list){
    (hasImage(item) ? withImg : withoutImg).push(item);
  }
  return [...withImg, ...withoutImg];
}

function getSectorValue(p){
  const raw = (p.setor || p.sector || p.categoria || p.departamento || '').toString().trim();
  // Mant√©m o valor do setor em branco para n√£o criar a op√ß√£o "Setor livre" no filtro
  return raw;
}
function getSectionValue(p){
  return (p.secao || p.section || p.subsetor || '').toString().trim();
}
function sectorFromPath(name){
  const path = (name || '').toString().replace(/\\/g, '/');
  const parts = path.split('/').filter(Boolean);
  if (!parts.length) return '';
  // se vier "PRODUTOS/Setor/Arquivo.xlsx", ignora a pasta raiz "PRODUTOS"
  const first = parts[0];
  const maybeSector = (first || '').toLowerCase();
  const sectorPart = (maybeSector === 'produtos' && parts.length > 1) ? parts[1] : first;
  const decoded = (() => { try{ return decodeURIComponent(sectorPart); }catch{ return sectorPart; } })();
  return decoded.replace(/[_-]+/g, ' ').trim();
}
function sectionFromPath(name, sectorHint){
  const path = (name || '').toString().replace(/\\/g, '/');
  const parts = path.split('/').filter(Boolean);
  if (!parts.length) return '';
  const file = parts[parts.length - 1];
  let fileNoExt = file.replace(/\.[^.]+$/, '');

  const sectorBase = (sectorHint || '').toString().trim();
  if (sectorBase){
    const escaped = sectorBase.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const rx = new RegExp(`^${escaped}\\s*[-_]\\s*`, 'i');
    fileNoExt = fileNoExt.replace(rx, '');
  }

  const decoded = (() => { try{ return decodeURIComponent(fileNoExt); }catch{ return fileNoExt; } })();
  return decoded.replace(/[_-]+/g, ' ').trim();
}

function sectorKey(val){
  return (val || '')
    .toString()
    .trim()
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g,'');
}
function encodeSectorValue(val){
  try{ return encodeURIComponent(val || ''); }catch{ return ''; }
}
function decodeSectorValue(val){
  if (!val || val === '__all') return '__all';
  try{ return decodeURIComponent(val); }catch{ return val; }
}
function sectionKey(val){
  return (val || '')
    .toString()
    .trim()
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g,'');
}
function encodeSectionValue(val){
  try{ return encodeURIComponent(val || ''); }catch{ return ''; }
}
function decodeSectionValue(val){
  if (!val || val === '__all') return '__all';
  try{ return decodeURIComponent(val); }catch{ return val; }
}

function buildSectorOptions(){
  if (!sectorFilter) return;
  const sectorMap = new Map();
  const pushSector = (v) => {
    const key = sectorKey(v);
    if (!key) return;
    if (!sectorMap.has(key)) sectorMap.set(key, v);
  };
  for (const p of itemsAll){
    const sv = getSectorValue(p);
    if (sv) pushSector(sv);
  }
  // acrescenta setores vindos dos caminhos dos arquivos carregados
  for (const sh of sectorHints){
    pushSector(sh);
  }
  DEFAULT_SECTORS.forEach(s => pushSector(s));
  const arr = Array.from(sectorMap.values()).sort((a, b) => a.localeCompare(b, 'pt-BR'));
  const sig = arr.join('|');
  if (sig === sectorOptionsSignature && sectorFilter.options.length > 1) return;

  const currentRaw = sectorFilter.value && sectorFilter.value !== '__all'
    ? decodeSectorValue(sectorFilter.value)
    : '__all';
  const opts = ['<option value="__all">Todos os setores</option>', ...arr.map(s => `<option value="${encodeSectorValue(s)}">${escapeHtml(s)}</option>`)];
  sectorFilter.innerHTML = opts.join('');
  const hasCurrent = currentRaw !== '__all' && arr.includes(currentRaw);
  sectorFilter.value = hasCurrent ? encodeSectorValue(currentRaw) : '__all';
  sectorOptionsSignature = sig;
}
function buildSectionOptions(selectedSectorRaw){
  if (!sectionFilter) return;
  const sectorNorm = sectorKey(selectedSectorRaw);
  const wrap = sectionFilterWrap;

  if (!sectorNorm || selectedSectorRaw === '__all'){
    sectionFilter.innerHTML = '<option value="__all">Todas as se√ß√µes</option>';
    sectionFilter.value = '__all';
    sectionFilter.disabled = true;
    if (wrap) wrap.classList.add('disabled');
    sectionOptionsSignature = '';
    return;
  }

  const sectionMap = new Map();
  for (const p of itemsAll){
    const secVal = getSectorValue(p);
    if (!secVal || sectorKey(secVal) !== sectorNorm) continue;
    const section = getSectionValue(p);
    const key = sectionKey(section);
    if (!key) continue;
    if (!sectionMap.has(key)) sectionMap.set(key, section);
  }
  const arr = Array.from(sectionMap.values()).sort((a, b) => a.localeCompare(b, 'pt-BR'));
  const sig = `${sectorNorm}__${arr.join('|')}`;
  const hasSections = arr.length > 0;

  if (sig === sectionOptionsSignature && sectionFilter.options.length){
    sectionFilter.disabled = !hasSections;
    if (wrap) wrap.classList.toggle('disabled', !hasSections);
    return;
  }

  const opts = ['<option value="__all">Todas as se√ß√µes</option>', ...arr.map(s => `<option value="${encodeSectionValue(s)}">${escapeHtml(s)}</option>`)];
  sectionFilter.innerHTML = opts.join('');
  sectionFilter.value = '__all';
  sectionFilter.disabled = !hasSections;
  if (wrap) wrap.classList.toggle('disabled', !hasSections);
  sectionOptionsSignature = sig;
}

function currentQuery(){
  const qCat = (catalogSearch?.value || '').trim();
  const qGlobal = (globalSearch?.value || '').trim();
  return (qCat || qGlobal).toLowerCase();
}

function applyFilters(){
  buildSectorOptions();
  const selectedSectorRaw = sectorFilter ? decodeSectorValue(sectorFilter.value) : '__all';
  buildSectionOptions(selectedSectorRaw);
  const q = currentQuery();
  const selKey = sectorKey(selectedSectorRaw);
  const selectedSectionRaw = sectionFilter ? decodeSectionValue(sectionFilter.value) : '__all';
  const selSectionKey = sectionKey(selectedSectionRaw);

  items = itemsAll.filter(p => {
    const secVal = getSectorValue(p);
    if (!secVal) return false; // ignora produtos sem setor
    const sectionVal = getSectionValue(p);
    const matchesText = !q || (p.nome || '').toLowerCase().includes(q);
    const matchesSector = !selectedSectorRaw || selectedSectorRaw === '__all'
      ? true
      : (sectorKey(secVal) === selKey);
    const matchesSection = !selectedSectionRaw || selectedSectionRaw === '__all'
      ? true
      : (sectionKey(sectionVal) === selSectionKey);
    return matchesText && matchesSector && matchesSection;
  });
  page = 1;
  render();
}

function render(){
  pages = Math.max(1, Math.ceil(items.length / PAGE_SIZE));
  if (page > pages) page = pages;

  const start = (page - 1) * PAGE_SIZE;
  const end = start + PAGE_SIZE;
  const slice = items.slice(start, end);

  if (!items.length){
    const selVal = sectorFilter ? sectorFilter.value : '__all';
    const selText = sectorFilter ? (sectorFilter.options[sectorFilter.selectedIndex]?.text || selVal) : '';
    const reason = selVal && selVal !== '__all'
      ? `o setor "${escapeHtml(selText || selVal)}"`
      : 'este filtro';
    gridEl.innerHTML = `<div class="catalog-empty">Sem produtos para ${reason}.</div>`;
    prevBtn.disabled = true;
    nextBtn.disabled = true;
    pageInfo.textContent = '';
    return;
  }

  gridEl.innerHTML = slice.map((p, idx) => {
    const img = resolveImgPath(p.imagem);
    const hasImg = !!img;
    const safeImg = escapeHtml(img);
    const cid = `img_${page}_${idx}`;
    const sectorValue = getSectorValue(p);
    const sectorLabel = sectorValue;
    const sectionLabel = getSectionValue(p);
    const pid = escapeHtml(`${p.nome || ''}||${p.preco || ''}||${p.imagem || ''}||${sectorValue || ''}||${sectionLabel || ''}`);
    const sectorPill = sectorLabel ? `<span class="catalog-pill">${escapeHtml(sectorLabel)}</span>` : '';
    const sectionPill = sectionLabel ? `<span class="catalog-pill catalog-pill-alt">${escapeHtml(sectionLabel)}</span>` : '';
    const tags = `<div class="catalog-tags">${sectorPill}${sectionPill}</div>`;

    return `
      <div class="catalog-card">
        <div class="catalog-meta">
          ${tags}
          <span class="catalog-price">${escapeHtml(p.preco)}</span>
        </div>
        <div class="catalog-thumb" id="${cid}_wrap">
          ${hasImg
            ? `<img id="${cid}" src="${safeImg}" alt="Imagem do produto" loading="lazy"
                 onerror="(function(){
                   const w=document.getElementById('${cid}_wrap');
                   if(w) w.innerHTML='<div class=&quot;catalog-noimg&quot;>Imagem indispon√≠vel</div>';
                 })();">`
            : `<div class="catalog-noimg">Sem imagem</div>`
          }
        </div>
        <p class="catalog-name">${escapeHtml(p.nome)}</p>
        <div class="catalog-actions">
          <div class="qty-control">
            <button class="qty-btn" type="button" data-qty="dec" data-key="${pid}">-</button>
            <input class="qty-input" type="number" min="1" value="1" data-key="${pid}">
            <button class="qty-btn" type="button" data-qty="inc" data-key="${pid}">+</button>
          </div>
          <button class="catalog-add" type="button"
            data-add-cart="${pid}"
            data-name="${escapeHtml(p.nome)}"
            data-price="${escapeHtml(p.preco)}"
            data-img="${safeImg}"
            data-sector="${escapeHtml(sectorLabel)}"
            data-section="${escapeHtml(sectionLabel)}">Adicionar</button>
        </div>
      </div>
    `;
  }).join('');

  prevBtn.disabled = page <= 1;
  nextBtn.disabled = page >= pages;
  pageInfo.textContent = '';
}

function updateCartCount(){
  if (!cartCountEl) return;
  let total = 0;
  for (const entry of cart.values()){
    total += entry.qty || 0;
  }
  cartCountEl.textContent = total;
  if (cartCountLabel) cartCountLabel.textContent = total;
  cartCountEl.classList.remove('bump');
  void cartCountEl.offsetWidth; // reflow to restart animation
  cartCountEl.classList.add('bump');
  updateCartFloater();
}

function toggleCartPanel(force){
  if (!cartPanel) return;
  const show = typeof force === 'boolean' ? force : !cartPanel.classList.contains('show');
  cartPanel.classList.toggle('show', show);
  if (show) renderCartPanel();
}

function selectSectorAndFilter(name){
  if (!sectorFilter || !name) return;
  buildSectorOptions();
  if (sectionFilter){
    sectionFilter.value = '__all';
    sectionOptionsSignature = '';
  }
  if (itemsBase.length) itemsAll = [...itemsBase];
  const targetKey = sectorKey(name);
  if (catalogSearch) catalogSearch.value = '';
  if (globalSearch) globalSearch.value = '';
  let found = false;
  for (const opt of Array.from(sectorFilter.options)){
    const optLabel = decodeSectorValue(opt.value);
    if (sectorKey(optLabel) === targetKey){
      sectorFilter.value = encodeSectorValue(optLabel);
      found = true;
      break;
    }
  }
  if (!found){
    const encoded = encodeSectorValue(name);
    const opt = new Option(name, encoded);
    sectorFilter.appendChild(opt);
    sectorFilter.value = encoded;
    sectorOptionsSignature = '';
  }
  applyFilters();
  document.getElementById('catalogoProdutos')?.scrollIntoView({ behavior:'smooth', block:'start' });
}

function parsePriceToNumber(str){
  if (!str) return 0;
  const cleaned = str.toString().replace(/\s/g,'').replace(/[R$\u00A0]/gi,'').replace(/\./g,'').replace(',','.');
  const num = parseFloat(cleaned);
  return Number.isFinite(num) ? num : 0;
}

function formatCurrency(num){
  return new Intl.NumberFormat('pt-BR', { style:'currency', currency:'BRL', minimumFractionDigits:2 }).format(num || 0);
}

function bestMarketEstimate(total){
  const markets = [
    { name:'Mercado A', factor:1 },
    { name:'Mercado B', factor:1.06 },
    { name:'Mercado C', factor:1.12 },
  ];
  let best = markets[0];
  for (const m of markets){
    if (total * m.factor < total * best.factor) best = m;
  }
  const diff = (total * best.factor) - (total * markets[0].factor);
  return `${best.name} (${formatCurrency(total * best.factor)}${diff ? ' estimado' : ''})`;
}

function renderCartPanel(){
  if (!cartItemsEl) return;
  if (!cart.size){
    cartItemsEl.innerHTML = `<div class="cart-empty">Nenhum item adicionado ainda.</div>`;
    return;
  }
  const entries = Array.from(cart.entries());
  cartItemsEl.innerHTML = entries.map(([key, { product, qty }]) => {
    const img = resolveImgPath(product.imagem);
    const sectionTag = product.secao ? `<span>${escapeHtml(product.secao || '')}</span>` : '';
    return `
      <div class="cart-item" data-cart-key="${escapeHtml(key)}">
        <div class="cart-thumb">
          ${img ? `<img src="${escapeHtml(img)}" alt="">` : 'Sem imagem'}
        </div>
        <div class="cart-info">
          <div class="cart-title">${escapeHtml(product.nome || '')}</div>
          <div class="cart-meta">
            <span>${escapeHtml(product.preco || '')}</span>
            <span>${escapeHtml(product.setor || '')}</span>
            ${sectionTag}
            <span>Qtd: ${qty}</span>
          </div>
          <button class="cart-remove" type="button" data-remove-key="${escapeHtml(key)}">Remover</button>
        </div>
      </div>
    `;
  }).join('');
}

function updateCartFloater(){
  if (!cartFloater) return;
  if (!cart.size){
    cartFloater.classList.remove('show');
    return;
  }

  let count = 0;
  let total = 0;
  for (const { product, qty } of cart.values()){
    count += qty || 0;
    total += parsePriceToNumber(product.preco) * (qty || 0);
  }

  if (floaterCount) floaterCount.textContent = `${count} ${count === 1 ? 'item' : 'itens'}`;
  if (floaterTotal) floaterTotal.textContent = formatCurrency(total);
  if (floaterBest) floaterBest.textContent = count ? bestMarketEstimate(total) : '-';

  cartFloater.classList.add('show');
}

function flashAdded(btn){
  if (!btn) return;
  const original = btn.textContent;
  btn.classList.add('added');
  btn.textContent = 'Adicionado';
  setTimeout(() => {
    btn.classList.remove('added');
    btn.textContent = original || 'Adicionar';
  }, 1200);
}

function addToCart(btn){
  if (!btn) return;
  const key = btn.dataset.addCart || btn.dataset.key;
  if (!key) return;

  const card = btn.closest('.catalog-card');
  const qtyInput = card ? card.querySelector('.qty-input') : null;
  const qty = Math.max(1, parseInt(qtyInput?.value, 10) || 1);

  const product = {
    nome: btn.dataset.name || 'Produto',
    preco: btn.dataset.price || '',
    imagem: btn.dataset.img || '',
    setor: btn.dataset.sector || '',
    secao: btn.dataset.section || ''
  };

  const current = cart.get(key) || { product, qty: 0 };
  current.qty += qty;
  cart.set(key, current);

  updateCartCount();
  renderCartPanel();
  flashAdded(btn);
}

prevBtn.addEventListener('click', () => { if (page > 1){ page--; render(); }});
nextBtn.addEventListener('click', () => { if (page < pages){ page++; render(); }});

gridEl.addEventListener('click', (ev) => {
  const qtyBtn = ev.target.closest('[data-qty]');
  if (qtyBtn){
    const control = qtyBtn.closest('.qty-control');
    const input = control ? control.querySelector('.qty-input') : null;
    if (input){
      let val = parseInt(input.value, 10) || 1;
      val = qtyBtn.dataset.qty === 'inc' ? val + 1 : Math.max(1, val - 1);
      input.value = val;
    }
  }

  const addBtn = ev.target.closest('[data-add-cart]');
  if (addBtn){
    addToCart(addBtn);
  }
});

gridEl.addEventListener('change', (ev) => {
  if (ev.target.matches('.qty-input')){
    const v = Math.max(1, parseInt(ev.target.value, 10) || 1);
    ev.target.value = v;
  }
});

cartItemsEl?.addEventListener('click', (ev) => {
  const remBtn = ev.target.closest('[data-remove-key]');
  if (remBtn){
    const key = remBtn.dataset.removeKey;
    if (key && cart.has(key)){
      cart.delete(key);
      updateCartCount();
      renderCartPanel();
    }
  }
});

function extOk(name){
  const n = (name || '').toLowerCase();
  return n.endsWith('.xlsx') || n.endsWith('.xlsm');
}

function gatherFiles(){
  const a = Array.from(dirPicker.files || []);
  const b = Array.from(filePicker.files || []);
  const merged = [...a, ...b].filter(f => extOk(f.name));
  const seen = new Set();
  const out = [];
  for (const f of merged){
    const key = `${f.webkitRelativePath||''}||${f.name}||${f.size}`;
    if (seen.has(key)) continue;
    seen.add(key);
    const sectorHint = sectorFromPath(f.webkitRelativePath || f.name || '');
    if (sectorHint) sectorHints.add(sectorHint);
    out.push(f);
  }
  return out;
}

/* ===========================
   ZIP / XLSX parser (sem libs)
=========================== */
function u16(dv, off){ return dv.getUint16(off, true); }
function u32(dv, off){ return dv.getUint32(off, true); }

function findEOCD(u8){
  const min = Math.max(0, u8.length - 65557);
  for (let i = u8.length - 22; i >= min; i--){
    if (u8[i] === 0x50 && u8[i+1] === 0x4b && u8[i+2] === 0x05 && u8[i+3] === 0x06){
      return i;
    }
  }
  return -1;
}

function parseZipEntries(u8){
  const dv = new DataView(u8.buffer, u8.byteOffset, u8.byteLength);
  const eocd = findEOCD(u8);
  if (eocd < 0) throw new Error('N√£o √© ZIP v√°lido (EOCD n√£o encontrado).');

  const totalEntries = u16(dv, eocd + 10);
  const cdOffset = u32(dv, eocd + 16);

  let ptr = cdOffset;
  const entries = new Map();

  for (let i = 0; i < totalEntries; i++){
    const sig = u32(dv, ptr);
    if (sig !== 0x02014b50) throw new Error('Central Directory inv√°lido.');

    const method = u16(dv, ptr + 10);
    const compSize = u32(dv, ptr + 20);
    const fnLen = u16(dv, ptr + 28);
    const exLen = u16(dv, ptr + 30);
    const cmLen = u16(dv, ptr + 32);
    const lho = u32(dv, ptr + 42);

    const nameBytes = u8.slice(ptr + 46, ptr + 46 + fnLen);
    const name = new TextDecoder('utf-8').decode(nameBytes);

    const lSig = u32(dv, lho);
    if (lSig !== 0x04034b50) throw new Error('Local header inv√°lido.');
    const lFnLen = u16(dv, lho + 26);
    const lExLen = u16(dv, lho + 28);
    const dataStart = lho + 30 + lFnLen + lExLen;

    entries.set(name, { name, method, compressedSize: compSize, dataStart });
    ptr = ptr + 46 + fnLen + exLen + cmLen;
  }
  return entries;
}

async function inflateRaw(u8){
  if (typeof DecompressionStream === 'undefined'){
    throw new Error('DecompressionStream n√£o dispon√≠vel.');
  }
  let ds;
  try{ ds = new DecompressionStream('deflate-raw'); }
  catch{ ds = new DecompressionStream('deflate'); }

  const stream = new Blob([u8]).stream().pipeThrough(ds);
  const ab = await new Response(stream).arrayBuffer();
  return new Uint8Array(ab);
}

async function readZipText(zipU8, entries, path){
  const e = entries.get(path);
  if (!e) return null;

  const comp = zipU8.slice(e.dataStart, e.dataStart + e.compressedSize);
  let out;
  if (e.method === 0) out = comp;
  else if (e.method === 8) out = await inflateRaw(comp);
  else throw new Error(`M√©todo ZIP n√£o suportado: ${e.method}`);

  return new TextDecoder('utf-8').decode(out);
}

function parseXml(text){
  const doc = new DOMParser().parseFromString(text, 'application/xml');
  if (doc.getElementsByTagName('parsererror').length) throw new Error('XML inv√°lido dentro do XLSX.');
  return doc;
}

function norm(s){
  return (s ?? '')
    .toString()
    .trim()
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g,'')
    .replace(/\s+/g,'');
}

function colToIndex(col){
  let n = 0;
  for (let i = 0; i < col.length; i++){
    n = n * 26 + (col.charCodeAt(i) - 64);
  }
  return n - 1;
}

function cellRefToColIndex(ref){
  const m = (ref || '').match(/[A-Z]+/);
  if (!m) return 0;
  return colToIndex(m[0]);
}

function readSharedStrings(doc){
  const out = [];
  const sis = doc.getElementsByTagName('si');
  for (const si of sis){
    const ts = si.getElementsByTagName('t');
    let s = '';
    for (const t of ts) s += (t.textContent ?? '');
    out.push(s);
  }
  return out;
}

function explodeRowDense(arr){
  const dense = arr.map(x => (x ?? '').toString().trim());
  const nonEmpty = dense.filter(x => x !== '');
  if (nonEmpty.length === 1){
    const cell = nonEmpty[0];
    if (cell.includes('\t') || cell.includes(';') || cell.includes(',')){
      return cell.split(/\t|;|,/).map(x => (x ?? '').toString().trim());
    }
  }
  let end = dense.length;
  while (end > 0 && dense[end-1] === '') end--;
  return dense.slice(0, end);
}

function findHeaderIndex(rows){
  const limit = Math.min(200, rows.length);
  let best = { idx: -1, score: 0 };

  for (let i = 0; i < limit; i++){
    const r = explodeRowDense(rows[i]);
    if (!r.length) continue;
    const cells = r.map(norm);

    const hasNome = cells.some(c => c === 'nome' || c.includes('nome') || c.includes('produto') || c.includes('descricao'));
    const hasPreco = cells.some(c => c === 'preco' || c.includes('preco') || c.includes('valor') || c.includes('price'));
    const hasImg  = cells.some(c => c === 'imagem' || c.includes('imagem') || c.includes('foto') || c.includes('image') || c === 'img');

    let score = 0;
    if (hasNome) score += 3;
    if (hasPreco) score += 3;
    if (hasImg) score += 1;

    if (score > best.score) best = { idx: i, score };
  }
  return best.score >= 6 ? best.idx : -1;
}

function detectCols(headerRow){
  const r = explodeRowDense(headerRow);
  const h = r.map(norm);

  const idxNome = h.findIndex(x => x === 'nome' || x.includes('nome') || x.includes('produto') || x.includes('descricao'));
  const idxPreco = h.findIndex(x => x === 'preco' || x.includes('preco') || x.includes('valor') || x.includes('price'));
  const idxImg  = h.findIndex(x => x === 'imagem' || x.includes('imagem') || x.includes('foto') || x.includes('image') || x === 'img');
  const idxSetor = h.findIndex(x => x === 'setor' || x === 'setores' || x.includes('categoria') || x.includes('departamento') || x.includes('setor'));
  const idxSecao = h.findIndex(x => x === 'secao' || x.includes('secao') || x.includes('subsetor') || x.includes('sessao'));

  return {
    nome: idxNome >= 0 ? idxNome : 2,
    preco: idxPreco >= 0 ? idxPreco : 3,
    img: idxImg >= 0 ? idxImg : 4,
    setor: idxSetor >= 0 ? idxSetor : -1,
    secao: idxSecao >= 0 ? idxSecao : -1
  };
}

function sheetToRows(sheetDoc, sharedStrings){
  const rowsOut = [];
  const rowNodes = sheetDoc.getElementsByTagName('row');

  for (const row of rowNodes){
    const cellNodes = row.getElementsByTagName('c');
    let maxCol = -1;
    const map = new Map();

    for (const c of cellNodes){
      const ref = c.getAttribute('r') || '';
      const colIdx = cellRefToColIndex(ref);
      if (colIdx > maxCol) maxCol = colIdx;

      const t = c.getAttribute('t');
      let val = '';

      if (t === 's'){
        const v = c.getElementsByTagName('v')[0];
        const idx = v ? parseInt(v.textContent || '0', 10) : 0;
        val = sharedStrings[idx] ?? '';
      }else if (t === 'inlineStr'){
        const isT = c.getElementsByTagName('t')[0];
        val = isT ? (isT.textContent ?? '') : '';
      }else{
        const v = c.getElementsByTagName('v')[0];
        val = v ? (v.textContent ?? '') : '';
      }

      map.set(colIdx, val);
    }

    const arr = new Array(Math.max(0, maxCol + 1)).fill('');
    for (const [k, v] of map.entries()) arr[k] = v;
    rowsOut.push(arr);
  }
  return rowsOut;
}

async function parseXlsxCatalog(fileLike){
  const zipU8 = new Uint8Array(await fileLike.arrayBuffer());
  const entries = parseZipEntries(zipU8);

  let sharedStrings = [];
  const ssText = await readZipText(zipU8, entries, 'xl/sharedStrings.xml');
  if (ssText){
    try{ sharedStrings = readSharedStrings(parseXml(ssText)); }catch{ sharedStrings = []; }
  }

  const sheetPaths = [];
  for (const k of entries.keys()){
    if (k.startsWith('xl/worksheets/') && k.endsWith('.xml')) sheetPaths.push(k);
  }
  sheetPaths.sort();

  for (const sp of sheetPaths){
    const sText = await readZipText(zipU8, entries, sp);
    if (!sText) continue;

    let doc;
    try{ doc = parseXml(sText); }catch{ continue; }

    const rows = sheetToRows(doc, sharedStrings);
    if (!rows.length) continue;

    const headerIdx = findHeaderIndex(rows);
    if (headerIdx < 0) continue;

    const cols = detectCols(rows[headerIdx]);

    const out = [];
    let emptyStreak = 0;

    for (let i = headerIdx + 1; i < rows.length; i++){
    const r = explodeRowDense(rows[i]);
    const nome = (r[cols.nome] ?? '').toString().trim();
    const preco = (r[cols.preco] ?? '').toString().trim();
    const imagem = (r[cols.img] ?? '').toString().trim();
    const setor = cols.setor >= 0 ? (r[cols.setor] ?? '').toString().trim() : '';
    const secao = cols.secao >= 0 ? (r[cols.secao] ?? '').toString().trim() : '';

    if (!nome){
      emptyStreak++;
      if (emptyStreak >= 40) break;
      continue;
    }
    emptyStreak = 0;
    out.push({ nome, preco, imagem, setor, secao });
  }

    if (out.length) return { items: out };
  }
  return { items: [] };
}

function dedupeProducts(arr){
  const seen = new Set();
  return arr.filter(p => {
    const k = `${p.nome}||${p.preco}||${p.imagem}||${getSectorValue(p)}||${getSectionValue(p)}`;
    if (seen.has(k)) return false;
    seen.add(k);
    return true;
  });
}

/* ===========================
   AUTO (index.json)
=========================== */
async function fetchJsonSafe(url){
  const res = await fetch(url, { cache: 'no-store' });
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  return await res.json();
}
function normalizeIndexJson(j){
  if (Array.isArray(j)) return j;
  if (j && Array.isArray(j.files)) return j.files;
  if (j && Array.isArray(j.arquivos)) return j.arquivos;
  return [];
}

/* ===========================
   SPEED: pool + cache + render progressivo
=========================== */
const FETCH_CONCURRENCY = 6;   // downloads simult√¢neos
const PARSE_CONCURRENCY = 2;   // parses simult√¢neos (CPU)
const RENDER_THROTTLE_MS = 180;
const CACHE_VERSION = 4;

async function pool(limit, list, worker){
  const ret = new Array(list.length);
  let i = 0;
  const runners = new Array(Math.min(limit, list.length)).fill(0).map(async () => {
    while (true){
      const idx = i++;
      if (idx >= list.length) break;
      ret[idx] = await worker(list[idx], idx);
    }
  });
  await Promise.all(runners);
  return ret;
}

async function sha256Base64(str){
  try{
    const data = new TextEncoder().encode(str);
    const hash = await crypto.subtle.digest('SHA-256', data);
    const bytes = new Uint8Array(hash);
    let bin = '';
    for (const b of bytes) bin += String.fromCharCode(b);
    return btoa(bin).replaceAll('=','');
  }catch{
    return btoa(unescape(encodeURIComponent(str))).slice(0,80).replaceAll('=','');
  }
}

async function cacheKeyFor(names){
  const sig = await sha256Base64(JSON.stringify(names));
  return `precovs_catalog_v${CACHE_VERSION}_${sig}`;
}

function cacheRead(key){
  try{
    const raw = localStorage.getItem(key);
    if (!raw) return null;
    const data = JSON.parse(raw);
    if (!Array.isArray(data)) return null;
    return data;
  }catch{
    return null;
  }
}

function cacheWrite(key, arr){
  try{
    localStorage.setItem(key, JSON.stringify(arr));
  }catch{
    // ignora
  }
}

let _lastRenderAt = 0;
function renderThrottled(){
  const now = performance.now();
  if (now - _lastRenderAt < RENDER_THROTTLE_MS) return;
  _lastRenderAt = now;
  applyFilters();
}

async function loadFromFilesProgressive(fileLikes){
  itemsAll = [];
  applyFilters();

  await pool(PARSE_CONCURRENCY, fileLikes, async (f) => {
    try{
      const res = await parseXlsxCatalog(f);
      if (res.items && res.items.length){
        const sectorHint = sectorFromPath(f.webkitRelativePath || f.name || '');
        const sectionHint = sectionFromPath(f.webkitRelativePath || f.name || '', sectorHint);
        if (sectorHint) sectorHints.add(sectorHint);
        const mapped = res.items.map(it => ({
          ...it,
          setor: it.setor || it.sector || it.categoria || it.departamento || sectorHint,
          secao: it.secao || it.section || it.subsetor || sectionHint
        }));
        itemsAll.push(...mapped);
        itemsAll = dedupeProducts(itemsAll);
        itemsAll = prioritizeImages(itemsAll);
        renderThrottled();
      }
    }catch(e){
      console.warn('XLSX erro:', f.name, e);
    }
  });

  itemsAll = dedupeProducts(itemsAll);
  itemsAll = prioritizeImages(itemsAll);
  itemsBase = [...itemsAll];
  applyFilters();
}

async function loadFromFiles(fileLikes){
  await loadFromFilesProgressive(fileLikes);
}

async function autoLoadSilent(){
  const t = Date.now();

  let idx;
  try{
    idx = await fetchJsonSafe(`./PRODUTOS/index.json?v=${t}`);
  }catch(e){
    console.warn('AUTO index.json falhou:', e);
    return;
  }

  const names = normalizeIndexJson(idx).filter(n => typeof n === 'string' && extOk(n));
  if (!names.length) return;

  const cKey = await cacheKeyFor(names);
  const cached = cacheRead(cKey);
  if (cached && cached.length){
    itemsAll = cached;
    itemsBase = [...itemsAll];
    applyFilters();
    return;
  }

  const virtualFiles = (await pool(FETCH_CONCURRENCY, names, async (name) => {
    const safeName = name.replace(/^\/+/,'');
    const url = `./PRODUTOS/${encodePath(safeName)}?v=${t}`;

    try{
      const sectorHint = sectorFromPath(safeName);
      const sectionHint = sectionFromPath(safeName, sectorHint);
      if (sectorHint) sectorHints.add(sectorHint);
      const r = await fetch(url, { cache: 'no-store' });
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      const ab = await r.arrayBuffer();
      return { name: safeName, sectorHint, sectionHint, arrayBuffer: async () => ab };
    }catch(e){
      console.warn('AUTO fetch falhou:', safeName, e);
      return null;
    }
  })).filter(Boolean);

  if (!virtualFiles.length) return;

  await loadFromFilesProgressive(virtualFiles);
  if (itemsAll.length){
    itemsAll = prioritizeImages(itemsAll);
    itemsBase = [...itemsAll];
    cacheWrite(cKey, itemsAll);
  }
}

/* ===========================
   EVENTOS (manual)
=========================== */
btnLoad.addEventListener('click', async () => {
  const files = gatherFiles();
  await loadFromFiles(files);
});

function syncGlobalToCatalog(){
  if (catalogSearch && globalSearch) catalogSearch.value = globalSearch.value;
  if (itemsBase.length) itemsAll = [...itemsBase];
  applyFilters();
}

globalSearch.addEventListener('input', syncGlobalToCatalog);
globalSearchBtn.addEventListener('click', syncGlobalToCatalog);
catalogSearch?.addEventListener('input', () => {
  if (globalSearch) globalSearch.value = catalogSearch.value;
  applyFilters();
});
catalogSearchClear?.addEventListener('click', () => {
  if (catalogSearch) catalogSearch.value = '';
  if (globalSearch) globalSearch.value = '';
  applyFilters();
});
sectorFilter?.addEventListener('change', () => {
  if (sectionFilter){
    sectionFilter.value = '__all';
    sectionOptionsSignature = '';
  }
  if (itemsBase.length) itemsAll = [...itemsBase];
  applyFilters();
});
sectionFilter?.addEventListener('change', () => {
  if (itemsBase.length) itemsAll = [...itemsBase];
  applyFilters();
});

/* ===========================
   CONTROLES: Ctrl+Shift+L ou #admin
=========================== */
const controls = document.getElementById('catalogControls');
function setControlsVisible(v){ controls.classList.toggle('show', !!v); }

document.addEventListener('keydown', (ev) => {
  if (ev.ctrlKey && ev.shiftKey && (ev.key === 'L' || ev.key === 'l')){
    setControlsVisible(!controls.classList.contains('show'));
  }
});

if (location.hash && location.hash.toLowerCase().includes('admin')){
  setControlsVisible(true);
}

btnAuto.addEventListener('click', autoLoadSilent);

document.querySelector('.cart')?.addEventListener('click', () => toggleCartPanel());
cartCloseBtn?.addEventListener('click', () => toggleCartPanel(false));
floaterOpenCart?.addEventListener('click', () => toggleCartPanel(true));
floaterVisitSite?.addEventListener('click', () => {
  try{
    window.open(SITE_URL, '_blank');
  }catch{
    location.href = SITE_URL;
  }
});

footerBackBtn?.addEventListener('click', () => {
  window.scrollTo({ top: 0, behavior: 'smooth' });
});

document.querySelector('.sectors-grid')?.addEventListener('click', (ev) => {
  const card = ev.target.closest('.sector-card');
  if (!card) return;
  const name = (card.textContent || '').trim();
  selectSectorAndFilter(name);
});

randomizeBtn?.addEventListener('click', () => {
  if (!itemsAll.length) return;
  if (!itemsBase.length) itemsBase = [...itemsAll];
  const shuffle = (arr) => arr
    .map(p => ({ p, sort: Math.random() }))
    .sort((a,b) => a.sort - b.sort)
    .map(({p}) => p);
  const withImg = [];
  const withoutImg = [];
  for (const p of itemsBase){
    (hasImage(p) ? withImg : withoutImg).push(p);
  }
  itemsAll = [...shuffle(withImg), ...shuffle(withoutImg)];
  applyFilters();
});

/* ===========================
   INIT (silencioso)
=========================== */
applyFilters();
autoLoadSilent();
</script>

</body>
</html>
