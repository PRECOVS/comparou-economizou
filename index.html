<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PreçoVs</title>

<style>
:root {
  --bg-main: #050505;
  --bg-header: #0a0a0a;
  --bg-section: #0f0f10;
  --bg-card: #151518;
  --bg-card-soft: #111115;
  --border-soft: #27272a;
  --text-main: #e5e5e5;
  --text-muted: #9ca3af;
  --accent-green: #22c55e;
  --accent-strong: #ffffff;
}

/* GLOBAL */
* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  background: radial-gradient(circle at top, #111827 0, #020617 45%, #000 100%);
  color: var(--text-main);
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
}

/* Containers */
.page-section { max-width: 1400px; margin: 0 auto; padding: 32px 16px; }
.section-title { font-size: 1.7rem; margin-bottom: 10px; font-weight: 600; }
.section-subtitle { color: var(--text-muted); font-size: 0.95rem; margin-bottom: 24px; }

/* ===========================
      HEADER
=========================== */
.top-header {
  background: var(--bg-header);
  padding: 12px 16px;
  color: white;
  border-bottom: 1px solid var(--border-soft);
}

.header-container {
  max-width: 1400px;
  margin: auto;
  display: flex;
  align-items: center;
  gap: 20px;
}

.logo {
  font-size: 1.8rem;
  font-weight: bold;
  color: white;
  letter-spacing: 0.03em;
}
.logo span { color: var(--accent-green); }

/* SEARCH */
.search-box { flex: 1; display: flex; }
.search-box input {
  flex: 1;
  padding: 10px;
  border: 1px solid #2e2e2e;
  background: #1a1a1a;
  color: white;
  border-radius: 6px 0 0 6px;
}
.search-box input::placeholder { color: #6b7280; }
.search-box button {
  padding: 10px 16px;
  border: none;
  background: #2e2e2e;
  color: white;
  border-radius: 0 6px 6px 0;
  cursor: pointer;
  font-weight: 500;
}
.search-box button:hover { background: #3b3b3b; }

/* ENDEREÇO */
.endereco {
  text-align: left;
  font-size: 0.85rem;
  line-height: 1.1rem;
  color: #e5e5e5;
  min-width: 140px;
}
.end-label { opacity: 0.6; }

/* ICONS AREA */
.account, .cart {
  display: flex;
  align-items: center;
  gap: 6px;
  cursor: pointer;
  color: #e5e5e5;
  font-size: 0.9rem;
}
.account span, .cart span { white-space: nowrap; }
.icon { width: 22px; height: 22px; filter: invert(100%); }

.cart { position: relative; }
.cart-count {
  position: absolute;
  top: -5px;
  right: -6px;
  background: #ef4444;
  padding: 2px 6px;
  font-size: 0.75rem;
  border-radius: 999px;
  font-weight: bold;
}

/* BARRA AVISO INTERMEDIADOR */
.info-bar { background: #020617; border-bottom: 1px solid var(--border-soft); }
.info-bar-inner {
  max-width: 1400px;
  margin: 0 auto;
  padding: 10px 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 0.85rem;
  color: var(--text-muted);
}
.info-pill {
  padding: 4px 10px;
  border-radius: 999px;
  border: 1px solid #1f2933;
  background: #020617;
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.06em;
}
.info-highlight { color: var(--accent-green); font-weight: 500; }

/* ===========================
      CARROSSEL
=========================== */
.carousel {
  position: relative;
  width: 100%;
  overflow: hidden;
  background: #000;
  border-bottom: 1px solid #111827;
}
.carousel-track { display: flex; transition: transform 0.5s ease; }
.carousel img { width: 100%; height: auto; object-fit: contain; display: block; }
.carousel-btn {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(15,23,42,0.6);
  border: 1px solid rgba(148,163,184,0.6);
  color: white;
  font-size: 2rem;
  padding: 8px 14px;
  cursor: pointer;
  border-radius: 999px;
  backdrop-filter: blur(6px);
}
.carousel-btn.prev { left: 18px; }
.carousel-btn.next { right: 18px; }
.carousel-btn:hover { background: rgba(15,23,42,0.9); }

/* ===========================
      HERO / CONCEITO
=========================== */
.hero {
  display: grid;
  grid-template-columns: minmax(0, 1.5fr) minmax(0, 1fr);
  gap: 28px;
  align-items: center;
}
.hero-left h1 { font-size: 2.2rem; margin-bottom: 12px; }
.hero-left h1 span { color: var(--accent-green); }
.hero-left p { color: var(--text-muted); font-size: 0.95rem; margin-bottom: 18px; }

.hero-badges { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 22px; }
.hero-badge {
  font-size: 0.75rem;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid var(--border-soft);
  background: var(--bg-card-soft);
  color: var(--text-muted);
}
.hero-actions { display: flex; flex-wrap: wrap; gap: 10px; }

.btn-primary {
  background: var(--accent-green);
  color: #020617;
  border: none;
  padding: 10px 18px;
  border-radius: 999px;
  font-weight: 600;
  font-size: 0.9rem;
  cursor: pointer;
}
.btn-outline {
  background: transparent;
  color: var(--accent-strong);
  border-radius: 999px;
  border: 1px solid var(--border-soft);
  padding: 9px 16px;
  font-size: 0.88rem;
  cursor: pointer;
}
.btn-outline:hover { background: #111827; }

.hero-right {
  background: radial-gradient(circle at top, #1f2937 0, #020617 65%);
  border-radius: 18px;
  padding: 16px 18px;
  border: 1px solid #1f2937;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.hero-right-title { font-size: 0.95rem; margin-bottom: 4px; }
.hero-compare-row {
  display: flex;
  justify-content: space-between;
  font-size: 0.85rem;
  padding: 8px 10px;
  border-radius: 10px;
  background: rgba(15,23,42,0.8);
  border: 1px solid #111827;
}
.hero-compare-row.best { border-color: var(--accent-green); background: rgba(22,163,74,0.08); }
.hero-legend { font-size: 0.75rem; color: var(--text-muted); margin-top: 6px; }

/* ===========================
      SETORES — SEM SCROLL
=========================== */
.sectors-box {
  margin-top: 18px;
  background: rgba(15,23,42,0.55);
  border: 1px solid #1f2937;
  border-radius: 18px;
  padding: 16px;
}
.sectors-grid {
  display: grid;
  grid-template-columns: repeat(12, minmax(0, 1fr));
  gap: 10px;
  overflow: hidden;
}
.sector-card {
  position: relative;
  overflow: hidden;
  border-radius: 14px;
  border: 1px solid #1f2937;
  background-color: #000;
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  aspect-ratio: 1 / 1;
  display: flex;
  align-items: flex-end;
  justify-content: center;
  padding: clamp(8px, 1vw, 14px) clamp(6px, 0.9vw, 10px);
  user-select: none;
  transition: transform 0.15s ease, border-color 0.15s ease;
}
.sector-card::before {
  content: "";
  position: absolute;
  inset: 0;
  background: linear-gradient(to top, rgba(0,0,0,0.78), rgba(0,0,0,0.18));
}
.sector-card span {
  position: relative;
  z-index: 1;
  font-size: clamp(0.55rem, 0.85vw, 0.88rem);
  font-weight: 650;
  color: var(--text-main);
  text-align: center;
  line-height: 1.1;
  padding: 0 4px;
}
.sector-card:hover { border-color: rgba(34,197,94,0.45); transform: translateY(-1px); }

.sectors-grid .sector-card:nth-child(1)  { background-image: url("setor1.png"); }
.sectors-grid .sector-card:nth-child(2)  { background-image: url("setor2.png"); }
.sectors-grid .sector-card:nth-child(3)  { background-image: url("setor3.png"); }
.sectors-grid .sector-card:nth-child(4)  { background-image: url("setor4.png"); }
.sectors-grid .sector-card:nth-child(5)  { background-image: url("setor5.png"); }
.sectors-grid .sector-card:nth-child(6)  { background-image: url("setor6.png"); }
.sectors-grid .sector-card:nth-child(7)  { background-image: url("setor7.png"); }
.sectors-grid .sector-card:nth-child(8)  { background-image: url("setor8.png"); }
.sectors-grid .sector-card:nth-child(9)  { background-image: url("setor9.png"); }
.sectors-grid .sector-card:nth-child(10) { background-image: url("setor10.png"); }
.sectors-grid .sector-card:nth-child(11) { background-image: url("setor11.png"); }
.sectors-grid .sector-card:nth-child(12) { background-image: url("setor12.png"); }

@media (max-width: 1200px) { .sectors-grid { grid-template-columns: repeat(6, minmax(0, 1fr)); } }
@media (max-width: 820px)  { .sectors-grid { grid-template-columns: repeat(4, minmax(0, 1fr)); } }
@media (max-width: 520px)  { .sectors-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }

/* ===========================
      CATÁLOGO — MODO "SÓ PRODUTOS"
=========================== */
.catalog-shell{
  margin-top: 16px;
  background: rgba(15,23,42,0.55);
  border: 1px solid #1f2937;
  border-radius: 18px;
  padding: 14px;
}

/* ESSE BLOCO FICA ESCONDIDO POR PADRÃO (CTRL+SHIFT+L ou #admin) */
.catalog-controls{
  display:none;
  margin-bottom: 12px;
  background: rgba(2,6,23,0.85);
  border: 1px solid #111827;
  border-radius: 14px;
  padding: 12px;
}
.catalog-controls.show{ display:block; }

.catalog-controls label{ font-size:12px; color: var(--text-muted); }
.catalog-controls input[type="file"]{ color: var(--text-muted); max-width: 520px; }
.catalog-controls .row{
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  align-items:flex-end;
}

.catalog-btn{
  background:#0f0f11;
  border:1px solid #1f2937;
  color:var(--text-main);
  padding:10px 14px;
  border-radius:10px;
  cursor:pointer;
  font-weight: 650;
}
.catalog-btn:disabled{ opacity:.5; cursor:not-allowed; }

.catalog-status, .catalog-debug{
  display:none; /* some com tudo */
}

.catalog-grid{
  display:grid;
  grid-template-columns: repeat(5, minmax(0, 1fr));
  gap: 12px;
}
.catalog-card{
  background: rgba(3,7,18,0.65);
  border: 1px solid #111827;
  border-radius: 14px;
  padding: 12px;
  min-height: 160px;
  display:flex;
  flex-direction:column;
  gap: 10px;
}
.catalog-thumb{
  width:100%;
  aspect-ratio: 1/1;
  border:1px solid #111827;
  border-radius: 12px;
  background: rgba(2,6,23,0.7);
  overflow:hidden;
  display:flex;
  align-items:center;
  justify-content:center;
}
.catalog-thumb img{
  width:100%;
  height:100%;
  object-fit:contain;
  display:block;
}
.catalog-noimg{
  font-size:12px;
  color: var(--text-muted);
  padding:8px;
  text-align:center;
}
.catalog-name{ font-weight:800; font-size:14px; line-height:1.2; margin:0; word-break:break-word; }
.catalog-price{ font-weight:950; color: var(--accent-green); white-space:nowrap; }

.catalog-pager{
  margin-top: 12px;
  display:flex;
  justify-content:center;
  align-items:center;
  gap: 10px;
  padding: 10px;
  border:1px solid #111827;
  background: rgba(2,6,23,0.85);
  border-radius: 14px;
}
.catalog-pager .info{
  display:none; /* some a info */
}

@media (max-width: 1200px){ .catalog-grid{ grid-template-columns: repeat(4, minmax(0,1fr)); } }
@media (max-width: 900px){ .catalog-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); } }

/* RESPONSIVO GERAL */
@media (max-width: 900px) {
  .header-container { flex-wrap: wrap; }
  .hero { grid-template-columns: minmax(0,1fr); }
  .info-bar-inner { flex-direction: column; align-items: flex-start; }
}
</style>
</head>

<body>

<header class="top-header">
  <div class="header-container">
    <div class="logo">Preço<span>Vs</span></div>

    <div class="search-box">
      <input id="globalSearch" type="text" placeholder="Pesquisar produtos...">
      <button id="globalSearchBtn" type="button">Buscar</button>
    </div>

    <div class="endereco">
      <span class="end-label">Entrega em:</span>
      <span id="enderecoCliente">Selecionar endereço</span>
    </div>

    <div class="account">
      <img src="https://cdn-icons-png.flaticon.com/512/1144/1144760.png" class="icon" alt="Conta">
      <span>Minha Conta</span>
    </div>

    <div class="cart">
      <img src="https://cdn-icons-png.flaticon.com/512/3144/3144456.png" class="icon" alt="Carrinho">
      <span>Carrinho</span>
      <div class="cart-count" id="cartCount">0</div>
    </div>
  </div>
</header>

<div class="info-bar">
  <div class="info-bar-inner">
    <div class="info-pill">Intermediador</div>
    <div>
      Nós não vendemos produtos. <span class="info-highlight">Você escolhe o carrinho ideal</span> e finaliza a compra direto no site do supermercado escolhido.
    </div>
  </div>
</div>

<!-- CARROSSEL (7 BANNERS) -->
<section class="carousel">
  <div class="carousel-track">
    <img src="banner1.png" alt="Banner 1">
    <img src="banner2.png" alt="Banner 2">
    <img src="banner3.png" alt="Banner 3">
    <img src="banner4.png" alt="Banner 4">
    <img src="banner5.png" alt="Banner 5">
    <img src="banner6.png" alt="Banner 6">
    <img src="banner7.png" alt="Banner 7">
  </div>
  <button class="carousel-btn prev" type="button">‹</button>
  <button class="carousel-btn next" type="button">›</button>
</section>

<section class="page-section">
  <div class="hero">
    <div class="hero-left">
      <h1>O jeito inteligente de montar seu carrinho <span>sem trocar de mercado toda hora</span>.</h1>
      <p>
        O PreçoVs conecta você a vários supermercados ao mesmo tempo.
        Você escolhe os produtos, nós mostramos quem está ganhando em valor total e onde compensa fechar a compra.
      </p>

      <div class="hero-badges">
        <div class="hero-badge">Não somos supermercado</div>
        <div class="hero-badge">Comparação em tempo quase real*</div>
        <div class="hero-badge">Foco em economia de tempo e dinheiro</div>
      </div>

      <div class="hero-actions">
        <button class="btn-primary" type="button" id="goCatalog">Começar a comparar</button>
        <button class="btn-outline" type="button" id="goHow">Ver como funciona passo a passo</button>
      </div>
    </div>

    <div class="hero-right">
      <div class="hero-right-title">Exemplo de comparação do seu carrinho:</div>

      <div class="hero-compare-row best">
        <span>Mercado A</span>
        <span>R$ 132,70</span>
        <span style="font-size:0.78rem;color:var(--accent-green);">Melhor opção</span>
      </div>
      <div class="hero-compare-row">
        <span>Mercado B</span>
        <span>R$ 141,20</span>
        <span style="font-size:0.78rem;color:var(--text-muted);">Diferença: +R$ 8,50</span>
      </div>
      <div class="hero-compare-row">
        <span>Mercado C</span>
        <span>R$ 149,90</span>
        <span style="font-size:0.78rem;color:var(--text-muted);">Diferença: +R$ 17,20</span>
      </div>

      <div class="hero-legend">
        Você adiciona detergente, leite, arroz... nós atualizamos qual mercado está na frente e quanto você está economizando.
      </div>
    </div>
  </div>

  <!-- SETORES -->
  <div class="sectors-box">
    <div class="sectors-grid">
      <div class="sector-card"><span>Mercearia Salgada</span></div>
      <div class="sector-card"><span>Mercearia Doce</span></div>
      <div class="sector-card"><span>Saudáveis</span></div>
      <div class="sector-card"><span>Bebidas</span></div>
      <div class="sector-card"><span>Perfumaria</span></div>
      <div class="sector-card"><span>Bazar</span></div>
      <div class="sector-card"><span>Limpeza</span></div>
      <div class="sector-card"><span>Frios</span></div>
      <div class="sector-card"><span>Açougue</span></div>
      <div class="sector-card"><span>Padaria</span></div>
      <div class="sector-card"><span>Hortifruti</span></div>
      <div class="sector-card"><span>Congelados</span></div>
    </div>
  </div>

  <!-- CATÁLOGO (SÓ PRODUTOS VISÍVEL) -->
  <div class="catalog-shell" id="catalogoProdutos">

    <!-- CONTROLES OCULTOS (não perde funcionalidade) -->
    <div class="catalog-controls" id="catalogControls">
      <div class="row">
        <div>
          <label>AUTO (GitHub Pages) — ./PRODUTOS/index.json</label><br>
          <button class="catalog-btn" id="btnAuto" type="button">AUTO carregar</button>
        </div>

        <div>
          <label>Opção A: selecionar pasta PRODUTOS</label><br>
          <input id="dirPicker" type="file" webkitdirectory multiple accept=".xlsx,.xlsm">
        </div>

        <div>
          <label>Opção B: selecionar arquivos</label><br>
          <input id="filePicker" type="file" multiple accept=".xlsx,.xlsm">
        </div>

        <button class="catalog-btn" id="btnLoad" type="button">Carregar</button>
      </div>
    </div>

    <div class="catalog-status" id="status"></div>
    <div class="catalog-debug" id="debug"></div>

    <div class="catalog-grid" id="grid"></div>

    <div class="catalog-pager">
      <button class="catalog-btn" id="prevBtn" type="button">Voltar</button>
      <button class="catalog-btn" id="nextBtn" type="button">Próximo</button>
      <div class="info" id="pageInfo">Página</div>
    </div>
  </div>
</section>

<script>
/* ===========================
   FIXOS / UI
=========================== */
let index = 0;
const track = document.querySelector('.carousel-track');
const slides = document.querySelectorAll('.carousel img');
const total = slides.length;

function updateCarousel(){ track.style.transform = `translateX(-${index * 100}%)`; }
document.querySelector('.next').onclick = () => { index = (index + 1) % total; updateCarousel(); };
document.querySelector('.prev').onclick = () => { index = (index - 1 + total) % total; updateCarousel(); };
setInterval(() => { index = (index + 1) % total; updateCarousel(); }, 5000);

document.getElementById('goCatalog').addEventListener('click', () => {
  document.getElementById('catalogoProdutos').scrollIntoView({ behavior: 'smooth', block: 'start' });
});
document.getElementById('goHow').addEventListener('click', () => {
  // mantém funcionalidade mesmo sem seção
  window.scrollTo({ top: document.body.scrollHeight * 0.4, behavior: 'smooth' });
});

/* ===========================
   CATÁLOGO (XLSX + AUTO)
=========================== */
const PAGE_SIZE = 50;
let itemsAll = [];
let items = [];
let page = 1;
let pages = 1;

const dirPicker = document.getElementById('dirPicker');
const filePicker = document.getElementById('filePicker');
const btnLoad = document.getElementById('btnLoad');
const btnAuto = document.getElementById('btnAuto');

const statusEl = document.getElementById('status');
const debugEl = document.getElementById('debug');
const gridEl = document.getElementById('grid');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const pageInfo = document.getElementById('pageInfo');

const globalSearch = document.getElementById('globalSearch');
const globalSearchBtn = document.getElementById('globalSearchBtn');

function setStatus(msg){ statusEl.textContent = msg; }
function setDebug(html){ debugEl.innerHTML = html; }
function escapeHtml(s){
  return (s ?? '').toString()
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#039;");
}

function encodePath(p){
  return (p || '')
    .split('/')
    .filter(Boolean)
    .map(encodeURIComponent)
    .join('/');
}

function resolveImgPath(raw){
  const img = (raw || '').toString().trim();
  if (!img) return '';
  const low = img.toLowerCase();
  if (low.startsWith('http://') || low.startsWith('https://') || low.startsWith('data:') || low.startsWith('blob:')) return img;
  if (img.startsWith('/')) return img;
  if (img.startsWith('./') || img.startsWith('../')) return img;
  return './' + img.replace(/^\/+/,'');
}

function applySearch(){
  const q = (globalSearch.value || '').trim().toLowerCase();
  items = !q ? [...itemsAll] : itemsAll.filter(p => (p.nome || '').toLowerCase().includes(q));
  page = 1;
  render();
}

function render(){
  pages = Math.max(1, Math.ceil(items.length / PAGE_SIZE));
  if (page > pages) page = pages;

  const start = (page - 1) * PAGE_SIZE;
  const end = start + PAGE_SIZE;
  const slice = items.slice(start, end);

  gridEl.innerHTML = slice.map((p, idx) => {
    const img = resolveImgPath(p.imagem);
    const hasImg = !!img;
    const safeImg = escapeHtml(img);
    const cid = `img_${page}_${idx}`;

    return `
      <div class="catalog-card">
        <div class="catalog-thumb" id="${cid}_wrap">
          ${hasImg
            ? `<img id="${cid}" src="${safeImg}" alt="Imagem do produto" loading="lazy"
                 onerror="(function(){
                   const w=document.getElementById('${cid}_wrap');
                   if(w) w.innerHTML='<div class=&quot;catalog-noimg&quot;>Imagem indisponível</div>';
                 })();">`
            : `<div class="catalog-noimg">Sem imagem</div>`
          }
        </div>
        <p class="catalog-name">${escapeHtml(p.nome)}</p>
        <div class="catalog-price">${escapeHtml(p.preco)}</div>
      </div>
    `;
  }).join('');

  prevBtn.disabled = page <= 1;
  nextBtn.disabled = page >= pages;
  pageInfo.textContent = '';
}

prevBtn.addEventListener('click', () => { if (page > 1){ page--; render(); }});
nextBtn.addEventListener('click', () => { if (page < pages){ page++; render(); }});

function extOk(name){
  const n = (name || '').toLowerCase();
  return n.endsWith('.xlsx') || n.endsWith('.xlsm');
}

function gatherFiles(){
  const a = Array.from(dirPicker.files || []);
  const b = Array.from(filePicker.files || []);
  const merged = [...a, ...b].filter(f => extOk(f.name));
  const seen = new Set();
  const out = [];
  for (const f of merged){
    const key = `${f.webkitRelativePath||''}||${f.name}||${f.size}`;
    if (seen.has(key)) continue;
    seen.add(key);
    out.push(f);
  }
  return out;
}

/* ===========================
   ZIP / XLSX parser (sem libs)
=========================== */
function u16(dv, off){ return dv.getUint16(off, true); }
function u32(dv, off){ return dv.getUint32(off, true); }

function findEOCD(u8){
  const min = Math.max(0, u8.length - 65557);
  for (let i = u8.length - 22; i >= min; i--){
    if (u8[i] === 0x50 && u8[i+1] === 0x4b && u8[i+2] === 0x05 && u8[i+3] === 0x06){
      return i;
    }
  }
  return -1;
}

function parseZipEntries(u8){
  const dv = new DataView(u8.buffer, u8.byteOffset, u8.byteLength);
  const eocd = findEOCD(u8);
  if (eocd < 0) throw new Error('Não é ZIP válido (EOCD não encontrado).');

  const totalEntries = u16(dv, eocd + 10);
  const cdOffset = u32(dv, eocd + 16);

  let ptr = cdOffset;
  const entries = new Map();

  for (let i = 0; i < totalEntries; i++){
    const sig = u32(dv, ptr);
    if (sig !== 0x02014b50) throw new Error('Central Directory inválido.');

    const method = u16(dv, ptr + 10);
    const compSize = u32(dv, ptr + 20);
    const fnLen = u16(dv, ptr + 28);
    const exLen = u16(dv, ptr + 30);
    const cmLen = u16(dv, ptr + 32);
    const lho = u32(dv, ptr + 42);

    const nameBytes = u8.slice(ptr + 46, ptr + 46 + fnLen);
    const name = new TextDecoder('utf-8').decode(nameBytes);

    const lSig = u32(dv, lho);
    if (lSig !== 0x04034b50) throw new Error('Local header inválido.');
    const lFnLen = u16(dv, lho + 26);
    const lExLen = u16(dv, lho + 28);
    const dataStart = lho + 30 + lFnLen + lExLen;

    entries.set(name, { name, method, compressedSize: compSize, dataStart });
    ptr = ptr + 46 + fnLen + exLen + cmLen;
  }
  return entries;
}

async function inflateRaw(u8){
  if (typeof DecompressionStream === 'undefined'){
    throw new Error('DecompressionStream não disponível.');
  }
  let ds;
  try{ ds = new DecompressionStream('deflate-raw'); }
  catch{ ds = new DecompressionStream('deflate'); }

  const stream = new Blob([u8]).stream().pipeThrough(ds);
  const ab = await new Response(stream).arrayBuffer();
  return new Uint8Array(ab);
}

async function readZipText(zipU8, entries, path){
  const e = entries.get(path);
  if (!e) return null;

  const comp = zipU8.slice(e.dataStart, e.dataStart + e.compressedSize);
  let out;
  if (e.method === 0) out = comp;
  else if (e.method === 8) out = await inflateRaw(comp);
  else throw new Error(`Método ZIP não suportado: ${e.method}`);

  return new TextDecoder('utf-8').decode(out);
}

function parseXml(text){
  const doc = new DOMParser().parseFromString(text, 'application/xml');
  if (doc.getElementsByTagName('parsererror').length) throw new Error('XML inválido dentro do XLSX.');
  return doc;
}

function norm(s){
  return (s ?? '')
    .toString()
    .trim()
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g,'')
    .replace(/\s+/g,'');
}

function colToIndex(col){
  let n = 0;
  for (let i = 0; i < col.length; i++){
    n = n * 26 + (col.charCodeAt(i) - 64);
  }
  return n - 1;
}

function cellRefToColIndex(ref){
  const m = (ref || '').match(/[A-Z]+/);
  if (!m) return 0;
  return colToIndex(m[0]);
}

function readSharedStrings(doc){
  const out = [];
  const sis = doc.getElementsByTagName('si');
  for (const si of sis){
    const ts = si.getElementsByTagName('t');
    let s = '';
    for (const t of ts) s += (t.textContent ?? '');
    out.push(s);
  }
  return out;
}

function explodeRowDense(arr){
  const dense = arr.map(x => (x ?? '').toString().trim());
  const nonEmpty = dense.filter(x => x !== '');
  if (nonEmpty.length === 1){
    const cell = nonEmpty[0];
    if (cell.includes('\t') || cell.includes(';') || cell.includes(',')){
      return cell.split(/\t|;|,/).map(x => (x ?? '').toString().trim());
    }
  }
  let end = dense.length;
  while (end > 0 && dense[end-1] === '') end--;
  return dense.slice(0, end);
}

function findHeaderIndex(rows){
  const limit = Math.min(200, rows.length);
  let best = { idx: -1, score: 0 };

  for (let i = 0; i < limit; i++){
    const r = explodeRowDense(rows[i]);
    if (!r.length) continue;
    const cells = r.map(norm);

    const hasNome = cells.some(c => c === 'nome' || c.includes('nome') || c.includes('produto') || c.includes('descricao'));
    const hasPreco = cells.some(c => c === 'preco' || c.includes('preco') || c.includes('valor') || c.includes('price'));
    const hasImg  = cells.some(c => c === 'imagem' || c.includes('imagem') || c.includes('foto') || c.includes('image') || c === 'img');

    let score = 0;
    if (hasNome) score += 3;
    if (hasPreco) score += 3;
    if (hasImg) score += 1;

    if (score > best.score) best = { idx: i, score };
  }
  return best.score >= 6 ? best.idx : -1;
}

function detectCols(headerRow){
  const r = explodeRowDense(headerRow);
  const h = r.map(norm);

  const idxNome = h.findIndex(x => x === 'nome' || x.includes('nome') || x.includes('produto') || x.includes('descricao'));
  const idxPreco = h.findIndex(x => x === 'preco' || x.includes('preco') || x.includes('valor') || x.includes('price'));
  const idxImg  = h.findIndex(x => x === 'imagem' || x.includes('imagem') || x.includes('foto') || x.includes('image') || x === 'img');

  return { nome: idxNome >= 0 ? idxNome : 2, preco: idxPreco >= 0 ? idxPreco : 3, img: idxImg >= 0 ? idxImg : 4 };
}

function sheetToRows(sheetDoc, sharedStrings){
  const rowsOut = [];
  const rowNodes = sheetDoc.getElementsByTagName('row');

  for (const row of rowNodes){
    const cellNodes = row.getElementsByTagName('c');
    let maxCol = -1;
    const map = new Map();

    for (const c of cellNodes){
      const ref = c.getAttribute('r') || '';
      const colIdx = cellRefToColIndex(ref);
      if (colIdx > maxCol) maxCol = colIdx;

      const t = c.getAttribute('t');
      let val = '';

      if (t === 's'){
        const v = c.getElementsByTagName('v')[0];
        const idx = v ? parseInt(v.textContent || '0', 10) : 0;
        val = sharedStrings[idx] ?? '';
      }else if (t === 'inlineStr'){
        const isT = c.getElementsByTagName('t')[0];
        val = isT ? (isT.textContent ?? '') : '';
      }else{
        const v = c.getElementsByTagName('v')[0];
        val = v ? (v.textContent ?? '') : '';
      }

      map.set(colIdx, val);
    }

    const arr = new Array(Math.max(0, maxCol + 1)).fill('');
    for (const [k, v] of map.entries()) arr[k] = v;
    rowsOut.push(arr);
  }
  return rowsOut;
}

async function parseXlsxCatalog(fileLike){
  const zipU8 = new Uint8Array(await fileLike.arrayBuffer());
  const entries = parseZipEntries(zipU8);

  let sharedStrings = [];
  const ssText = await readZipText(zipU8, entries, 'xl/sharedStrings.xml');
  if (ssText){
    try{ sharedStrings = readSharedStrings(parseXml(ssText)); }catch{ sharedStrings = []; }
  }

  const sheetPaths = [];
  for (const k of entries.keys()){
    if (k.startsWith('xl/worksheets/') && k.endsWith('.xml')) sheetPaths.push(k);
  }
  sheetPaths.sort();

  for (const sp of sheetPaths){
    const sText = await readZipText(zipU8, entries, sp);
    if (!sText) continue;

    let doc;
    try{ doc = parseXml(sText); }catch{ continue; }

    const rows = sheetToRows(doc, sharedStrings);
    if (!rows.length) continue;

    const headerIdx = findHeaderIndex(rows);
    if (headerIdx < 0) continue;

    const cols = detectCols(rows[headerIdx]);

    const out = [];
    let emptyStreak = 0;

    for (let i = headerIdx + 1; i < rows.length; i++){
      const r = explodeRowDense(rows[i]);
      const nome = (r[cols.nome] ?? '').toString().trim();
      const preco = (r[cols.preco] ?? '').toString().trim();
      const imagem = (r[cols.img] ?? '').toString().trim();

      if (!nome){
        emptyStreak++;
        if (emptyStreak >= 40) break;
        continue;
      }
      emptyStreak = 0;
      out.push({ nome, preco, imagem });
    }

    if (out.length){
      return { items: out };
    }
  }
  return { items: [] };
}

function dedupeProducts(arr){
  const seen = new Set();
  return arr.filter(p => {
    const k = `${p.nome}||${p.preco}||${p.imagem}`;
    if (seen.has(k)) return false;
    seen.add(k);
    return true;
  });
}

async function loadFromFiles(fileLikes){
  let merged = [];
  for (const f of fileLikes){
    try{
      const res = await parseXlsxCatalog(f);
      if (res.items.length) merged.push(...res.items);
    }catch(e){
      console.warn('XLSX erro:', f.name, e);
    }
  }

  merged = dedupeProducts(merged);
  itemsAll = merged;
  applySearch();
}

btnLoad.addEventListener('click', async () => {
  const files = gatherFiles();
  await loadFromFiles(files);
});

globalSearch.addEventListener('input', applySearch);
globalSearchBtn.addEventListener('click', applySearch);

// AUTO via index.json (silencioso)
async function fetchJsonSafe(url){
  const res = await fetch(url, { cache: 'no-store' });
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  return await res.json();
}
function normalizeIndexJson(j){
  if (Array.isArray(j)) return j;
  if (j && Array.isArray(j.files)) return j.files;
  if (j && Array.isArray(j.arquivos)) return j.arquivos;
  return [];
}

async function autoLoadSilent(){
  const t = Date.now();
  try{
    const idx = await fetchJsonSafe(`./PRODUTOS/index.json?v=${t}`);
    const names = normalizeIndexJson(idx).filter(n => typeof n === 'string' && extOk(n));
    const virtualFiles = [];

    for (const name of names){
      const safeName = name.replace(/^\/+/,'');
      const url = `./PRODUTOS/${encodePath(safeName)}?v=${t}`;
      try{
        const r = await fetch(url, { cache: 'no-store' });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const ab = await r.arrayBuffer();
        virtualFiles.push({ name: safeName, arrayBuffer: async () => ab });
      }catch(e){
        console.warn('AUTO fetch falhou:', safeName, e);
      }
    }

    if (virtualFiles.length) await loadFromFiles(virtualFiles);
  }catch(e){
    console.warn('AUTO index.json falhou:', e);
  }
}

// CONTROLES: abrir com Ctrl+Shift+L ou URL com #admin
const controls = document.getElementById('catalogControls');
function setControlsVisible(v){ controls.classList.toggle('show', !!v); }

document.addEventListener('keydown', (ev) => {
  if (ev.ctrlKey && ev.shiftKey && (ev.key === 'L' || ev.key === 'l')){
    setControlsVisible(!controls.classList.contains('show'));
  }
});

if (location.hash && location.hash.toLowerCase().includes('admin')){
  setControlsVisible(true);
}

btnAuto.addEventListener('click', autoLoadSilent);

// init
render();
autoLoadSilent();
</script>

</body>
</html>
